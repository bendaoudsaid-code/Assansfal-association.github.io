<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANSFAL - Association pour la Coopération, le Développement et l'Environnement</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Tous les styles restent identiques... */
        /* ... (le CSS complet reste exactement le même) ... */
    </style>
</head>
<body>
    <!-- ==================== BARRE ADMIN ==================== -->
    <div class="admin-bar" id="adminBar">
        <div class="admin-controls">
            <span id="adminModeText"><strong>Mode Administrateur</strong><br><small>Modification du contenu activée</small></span>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="saveContent()">
                    <i class="fas fa-save"></i> <span id="saveBtnText">Sauvegarder</span>
                </button>
                <button class="admin-btn" onclick="showMediaLibrary()">
                    <i class="fas fa-images"></i> <span id="libraryBtnText">Bibliothèque</span>
                </button>
                <button class="admin-btn" onclick="showCommentsAdmin()">
                    <i class="fas fa-comments"></i> <span id="commentsBtnText">Commentaires</span>
                </button>
                <button class="admin-btn" onclick="showUserManagement()">
                    <i class="fas fa-users"></i> <span id="usersBtnText">Gestion Utilisateurs</span>
                </button>
                <button class="admin-btn" onclick="showChangePasswordModal('admin')">
                    <i class="fas fa-key"></i> <span id="changePassBtnText">Changer mot de passe</span>
                </button>
                <button class="admin-btn" onclick="logoutAdmin()" style="margin-top: 20px; background-color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> <span id="logoutBtnText">Déconnexion</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== BARRE WEBMASTER ==================== -->
    <div class="webmaster-bar" id="webmasterBar">
        <div class="webmaster-controls">
            <span id="webmasterModeText"><strong>Mode Webmaster</strong><br><small>Gestion des médias activée</small></span>
            <div class="webmaster-buttons">
                <button class="webmaster-btn" onclick="showMediaLibrary()">
                    <i class="fas fa-images"></i> <span id="webmasterLibraryBtnText">Bibliothèque Média</span>
                </button>
                <button class="webmaster-btn" onclick="showUploadModal()">
                    <i class="fas fa-cloud-upload-alt"></i> <span id="uploadBtnText">Uploader Fichiers</span>
                </button>
                <button class="webmaster-btn" onclick="showCommentsAdmin()">
                    <i class="fas fa-comments"></i> <span id="webmasterCommentsBtnText">Modérer Commentaires</span>
                </button>
                <button class="webmaster-btn" onclick="showChangePasswordModal('webmaster')">
                    <i class="fas fa-key"></i> <span id="webmasterChangePassBtnText">Changer mot de passe</span>
                </button>
                <button class="webmaster-btn" onclick="logoutWebmaster()" style="margin-top: 20px; background-color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> <span id="webmasterLogoutBtnText">Déconnexion</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== COMPTEUR VISITEURS ==================== -->
    <div class="visitor-counter" id="visitorCounter">
        <div class="container">
            <span id="visitorsLabel">Visiteurs: <span class="visitor-count" id="totalVisitors">0</span></span>
            <span id="onlineLabel">En ligne: <span class="visitor-count" id="onlineVisitors">0</span></span>
            <span id="lastVisitLabel">Dernière visite: <span id="lastVisit">--/--/---- --:--:--</span></span>
        </div>
    </div>

    <!-- ==================== SÉLECTEUR DE LANGUE ==================== -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="changeLanguage('fr')">
            <i class="fas fa-flag"></i> FR
        </button>
        <button class="lang-btn" onclick="changeLanguage('ar')">
            <i class="fas fa-star-and-crescent"></i> AR
        </button>
    </div>

    <!-- ==================== EN-TÊTE ==================== -->
    <header>
        <div class="container header-container">
            <div class="logo editable" data-id="logo">
                <i class="fas fa-hands-helping"></i>
                <div class="logo-text">
                    <h1 data-editable="true" data-id="siteTitle">ASSOCIATION ANSFAL</h1>
                    <p data-editable="true" data-id="siteSubtitle">Coopération, Développement & Environnement</p>
                </div>
                <button class="edit-btn" onclick="editText('siteTitle')">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#home" id="navHome">Accueil</a></li>
                    <li><a href="#about" id="navAbout">À propos</a></li>
                    <li><a href="#gallery" id="navGallery">Galerie</a></li>
                    <li><a href="#videos" id="navVideos">Vidéos</a></li>
                    <li><a href="#projects" id="navProjects">Projets</a></li>
                    <li><a href="#publications" id="navPublications">Publications</a></li>
                    <li><a href="#comments" id="navComments">Commentaires</a></li>
                    <li><a href="#contact" id="navContact">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ==================== SECTION HÉRO ==================== -->
    <section class="hero" id="home">
        <div class="container">
            <h2 class="editable" data-id="heroTitle" data-editable="true">ANSFAL</h2>
            <button class="edit-btn" onclick="editText('heroTitle')">
                <i class="fas fa-edit"></i>
            </button>
            
            <h3 class="editable" data-id="heroSubtitle" data-editable="true">Association pour la Coopération, le Développement et l'Environnement</h3>
            <button class="edit-btn" onclick="editText('heroSubtitle')">
                <i class="fas fa-edit"></i>
            </button>
            
            <p class="editable" data-id="heroText" data-editable="true">Œuvrant pour un développement durable, la coopération nationale et la protection de l'environnement depuis 2023.</p>
            <button class="edit-btn" onclick="editText('heroText')">
                <i class="fas fa-edit"></i>
            </button>
            
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 30px;">
                <a href="#projects" class="btn" id="btnDiscover">Découvrir nos actions</a>
                <a href="#gallery" class="btn" id="btnGallery" style="background-color: var(--info); border-color: var(--info);">
                    <i class="fas fa-images"></i> Galerie
                </a>
                <a href="#comments" class="btn" id="btnComments" style="background-color: var(--warning); border-color: var(--warning);" onclick="scrollToComments()">
                    <i class="fas fa-comments"></i> Commentaires
                </a>
            </div>
        </div>
    </section>

    <!-- ==================== À PROPOS ==================== -->
    <section class="about" id="about">
        <div class="container">
            <div class="section-header">
                <div class="section-title">
                    <h2 class="editable" data-id="aboutTitle" data-editable="true">À propos d'ANSFAL</h2>
                    <button class="edit-btn" onclick="editText('aboutTitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-section-btn" onclick="addAboutItem()" title="Ajouter un élément à la section">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="about-content">
                <div class="about-text">
                    <h3 class="editable" data-id="aboutSubtitle" data-editable="true">Notre histoire</h3>
                    <button class="edit-btn" onclick="editText('aboutSubtitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                    
                    <p class="editable" data-id="aboutText1" data-editable="true">Fondée en 2023, l'Association ANSFAL POUR LA COOPÉRATION ET LE DÉVELOPPEMENT ET L'ENVIRONNEMENT est née de la conviction que le développement humain et la protection environnementale doivent aller de pair.</p>
                    <button class="edit-btn" onclick="editText('aboutText1')">
                        <i class="fas fa-edit"></i>
                    </button>
                    
                    <p class="editable" data-id="aboutText2" data-editable="true">Notre nom 'ANSFAL' symbolise notre engagement pour un avenir meilleur, basé sur la solidarité, le développement durable et la préservation de notre environnement.</p>
                    <button class="edit-btn" onclick="editText('aboutText2')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="about-img image-editable" data-id="aboutImage">
                    <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80" alt="Équipe ANSFAL">
                    <button class="image-edit-btn" onclick="editImage('aboutImage')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- ==================== GALERIE ==================== -->
    <section class="gallery media-section" id="gallery">
        <div class="container">
            <div class="section-header">
                <div class="section-title">
                    <h2 class="editable" data-id="galleryTitle" data-editable="true">Galerie Photos</h2>
                    <button class="edit-btn" onclick="editText('galleryTitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-section-btn" onclick="addGalleryItem()" title="Ajouter une image à la galerie">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <!-- Les images de la galerie seront ajoutées ici dynamiquement -->
                <div class="gallery-item image-editable" data-id="gallery1">
                    <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80" alt="Projet environnemental">
                    <button class="image-edit-btn" onclick="editImage('gallery1')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="add-item-btn" onclick="addGalleryItem()" title="Ajouter une image">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeGalleryItem('gallery1')" title="Supprimer cette image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="empty-state" id="galleryEmptyState" style="display: none;">
                <i class="fas fa-images"></i>
                <p>Aucune image dans la galerie</p>
                <small>Cliquez sur le bouton + pour ajouter une image</small>
            </div>
        </div>
    </section>

    <!-- ==================== VIDÉOS ==================== -->
    <section class="videos media-section" id="videos">
        <div class="container">
            <div class="section-header">
                <div class="section-title">
                    <h2 class="editable" data-id="videosTitle" data-editable="true">Vidéos</h2>
                    <button class="edit-btn" onclick="editText('videosTitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-section-btn" onclick="addVideoItem()" title="Ajouter une vidéo">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="video-container" id="videoContainer">
                <!-- Les vidéos seront ajoutées ici dynamiquement -->
                <div class="video-item">
                    <div class="youtube-embed">
                        <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe>
                    </div>
                    <button class="add-item-btn" onclick="addVideoItem()" title="Ajouter une vidéo">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeVideoItem(this)" title="Supprimer cette vidéo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="empty-state" id="videosEmptyState" style="display: none;">
                <i class="fas fa-video"></i>
                <p>Aucune vidéo disponible</p>
                <small>Cliquez sur le bouton + pour ajouter une vidéo</small>
            </div>
        </div>
    </section>

    <!-- ==================== PROJETS ==================== -->
    <section class="projects media-section" id="projects">
        <div class="container">
            <div class="section-header">
                <div class="section-title">
                    <h2 class="editable" data-id="projectsTitle" data-editable="true">Nos Projets</h2>
                    <button class="edit-btn" onclick="editText('projectsTitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-section-btn" onclick="addProjectItem()" title="Ajouter un projet">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="projects-container" id="projectsContainer">
                <!-- Les projets seront ajoutés ici dynamiquement -->
                <div class="project-card">
                    <div class="project-img image-editable" data-id="project1">
                        <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80" alt="Projet Environnement">
                        <button class="image-edit-btn" onclick="editImage('project1')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="project-info">
                        <h3 class="editable" data-id="projectTitle1" data-editable="true">Protection des Forêts</h3>
                        <button class="edit-btn" onclick="editText('projectTitle1')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <p class="editable" data-id="projectDesc1" data-editable="true">Campagne de reboisement et sensibilisation à la protection des écosystèmes forestiers.</p>
                        <button class="edit-btn" onclick="editText('projectDesc1')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <button class="add-item-btn" onclick="addProjectItem()" title="Ajouter un projet">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeProjectItem(this)" title="Supprimer ce projet">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="empty-state" id="projectsEmptyState" style="display: none;">
                <i class="fas fa-project-diagram"></i>
                <p>Aucun projet disponible</p>
                <small>Cliquez sur le bouton + pour ajouter un projet</small>
            </div>
        </div>
    </section>

    <!-- ==================== PUBLICATIONS ==================== -->
    <section class="publications media-section" id="publications">
        <div class="container">
            <div class="section-header">
                <div class="section-title">
                    <h2 class="editable" data-id="publicationsTitle" data-editable="true">Publications</h2>
                    <button class="edit-btn" onclick="editText('publicationsTitle')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-section-btn" onclick="addPublicationItem()" title="Ajouter une publication">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="publications-grid" id="publicationsGrid">
                <!-- Les publications seront ajoutées ici dynamiquement -->
                <div class="publication-card">
                    <div class="publication-header">
                        <span class="publication-type">Rapport</span>
                        <span class="publication-date">15/03/2024</span>
                    </div>
                    <div class="publication-content">
                        <h3 class="publication-title editable" data-id="pubTitle1" data-editable="true">Rapport Annuel 2023</h3>
                        <button class="edit-btn" onclick="editText('pubTitle1')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <p class="publication-description editable" data-id="pubDesc1" data-editable="true">Bilan des activités et réalisations de l'association pour l'année 2023.</p>
                        <button class="edit-btn" onclick="editText('pubDesc1')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <div class="publication-actions">
                            <a href="#" class="btn-view">
                                <i class="fas fa-eye"></i> <span class="btn-view-text">Voir</span>
                            </a>
                            <a href="#" class="btn-download">
                                <i class="fas fa-download"></i> <span class="btn-download-text">Télécharger</span>
                            </a>
                        </div>
                    </div>
                    <button class="add-item-btn" onclick="addPublicationItem()" title="Ajouter une publication">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removePublicationItem(this)" title="Supprimer cette publication">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="empty-state" id="publicationsEmptyState" style="display: none;">
                <i class="fas fa-file-alt"></i>
                <p>Aucune publication disponible</p>
                <small>Cliquez sur le bouton + pour ajouter une publication</small>
            </div>
        </div>
    </section>

    <!-- ==================== COMMENTAIRES ==================== -->
    <section class="comments-section" id="comments">
        <div class="container">
            <h2 class="editable" data-id="commentsTitle" data-editable="true">Commentaires</h2>
            <button class="edit-btn" onclick="editText('commentsTitle')">
                <i class="fas fa-edit"></i>
            </button>
            <div class="comment-form">
                <h3>Laissez un commentaire</h3>
                <input type="text" id="commentNameInput" placeholder="Votre nom">
                <textarea id="commentTextInput" placeholder="Votre commentaire"></textarea>
                <button class="btn" onclick="submitComment()" id="btnSubmitComment">Publier le commentaire</button>
            </div>
            <div class="comments-list" id="commentsList">
                <!-- Les commentaires seront ajoutés ici -->
            </div>
        </div>
    </section>

    <!-- ==================== CONTACT ==================== -->
    <section class="contact" id="contact">
        <div class="container">
            <h2 class="editable" data-id="contactTitle" data-editable="true">Contactez-nous</h2>
            <button class="edit-btn" onclick="editText('contactTitle')">
                <i class="fas fa-edit"></i>
            </button>
            <div class="contact-info">
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Adresse</h3>
                    <p class="editable" data-id="contactAddress" data-editable="true">Maroc</p>
                    <button class="edit-btn" onclick="editText('contactAddress')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <h3>Téléphone</h3>
                    <p class="editable" data-id="contactPhone" data-editable="true">+212 6 12 34 56 78</p>
                    <button class="edit-btn" onclick="editText('contactPhone')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <h3>Email</h3>
                    <p class="editable" data-id="contactEmail" data-editable="true">contact@ansfal.org</p>
                    <button class="edit-btn" onclick="editText('contactEmail')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- ==================== FOOTER ==================== -->
    <footer>
        <div class="container">
            <div class="footer-container">
                <div class="footer-logo">
                    <div class="logo">
                        <i class="fas fa-hands-helping"></i>
                        <div class="logo-text">
                            <h3 style="color: white;">ANSFAL</h3>
                            <p style="color: rgba(255,255,255,0.8);">Coopération, Développement & Environnement</p>
                        </div>
                    </div>
                </div>
                <div class="footer-social">
                    <h4 id="followUs">Suivez-nous</h4>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p id="copyrightText">&copy; 2024 Association ANSFAL. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <!-- ==================== BOUTONS FLOTTANTS ==================== -->
    <a href="#" class="whatsapp-float" id="whatsappBtn">
        <i class="fab fa-whatsapp"></i>
        <span class="whatsapp-tooltip">Contactez-nous sur WhatsApp</span>
    </a>

    <button class="media-library-btn" id="mediaLibraryBtn" onclick="showMediaLibrary()">
        <i class="fas fa-images"></i>
    </button>

    <button class="comments-btn" id="commentsBtn" onclick="showCommentsModal()">
        <i class="fas fa-comments"></i>
        <span class="comments-badge"></span>
    </button>

    <button class="login-btn" id="loginBtn" onclick="showLoginModal()">
        <i class="fas fa-user-shield"></i>
    </button>

    <button class="webmaster-btn-float" id="webmasterBtn" onclick="showWebmasterLoginModal()">
        <i class="fas fa-user-cog"></i>
    </button>

    <!-- ==================== JAVASCRIPT COMPLET - CORRIGÉ ==================== -->
    <script>
        // ==================== SYSTÈME DE GESTION DE CONTENU ====================
        
        // Variables globales
        let isAdmin = false;
        let isWebmaster = false;
        let currentLanguage = 'fr';
        let contentData = {};
        let mediaLibrary = [];
        let pendingComments = [];
        let approvedComments = [];
        let visitorStats = {
            total: 0,
            online: 0,
            lastVisit: null
        };

        // Stockage des éléments par section
        let galleryItems = [];
        let videoItems = [];
        let projectItems = [];
        let publicationItems = [];

        // Gestion des utilisateurs
        let users = [
            {
                id: 1,
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                name: 'Administrateur Principal'
            },
            {
                id: 2,
                username: 'webmaster',
                password: 'web123',
                role: 'webmaster',
                name: 'Webmaster Principal'
            }
        ];

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page chargée - Initialisation...");
            
            // Charger les données depuis le localStorage
            loadContentData();
            loadMediaLibrary();
            loadComments();
            loadVisitorStats();
            loadSectionItems();
            loadUsers();
            
            // Charger la langue sauvegardée ou utiliser français par défaut
            const savedLang = localStorage.getItem('ansfal_language') || 'fr';
            changeLanguage(savedLang);
            
            // Mettre à jour l'affichage
            updateVisitorDisplay();
            updateCommentsBadge();
            renderCommentsList();
            
            // Vérifier si on est en mode admin ou webmaster
            checkAdminStatus();
            checkWebmasterStatus();
            
            // Initialiser les événements
            initEventListeners();
            
            // Afficher/masquer les états vides
            checkEmptyStates();
            
            console.log("Initialisation terminée - Langue:", currentLanguage);
        });

        // ==================== GESTION DES LANGUES ====================
        function changeLanguage(lang) {
            // Mettre à jour les boutons de langue
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.lang-btn[onclick="changeLanguage('${lang}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Changer la direction du texte
            if (lang === 'ar') {
                document.body.classList.add('rtl');
                document.body.style.direction = 'rtl';
                document.body.style.textAlign = 'right';
            } else {
                document.body.classList.remove('rtl');
                document.body.style.direction = 'ltr';
                document.body.style.textAlign = 'left';
            }
            
            // Mettre à jour la langue courante
            currentLanguage = lang;
            localStorage.setItem('ansfal_language', lang);
            
            // Traduire toute la page
            translateCompletePage(lang);
            
            // Mettre à jour le compteur de visiteurs
            updateVisitorDisplay();
        }

        function translateCompletePage(lang) {
            const translations = {
                'fr': {
                    // Titres de section
                    'aboutTitle': 'À propos d\'ANSFAL',
                    'galleryTitle': 'Galerie Photos',
                    'videosTitle': 'Vidéos',
                    'projectsTitle': 'Nos Projets',
                    'publicationsTitle': 'Publications',
                    'commentsTitle': 'Commentaires',
                    'contactTitle': 'Contactez-nous',
                    
                    // Logo
                    'siteTitle': 'ASSOCIATION ANSFAL',
                    'siteSubtitle': 'Coopération, Développement & Environnement',
                    
                    // Hero section
                    'heroTitle': 'ANSFAL',
                    'heroSubtitle': 'Association pour la Coopération, le Développement et l\'Environnement',
                    'heroText': 'Œuvrant pour un développement durable, la coopération nationale et la protection de l\'environnement depuis 2023.',
                    
                    // About section
                    'aboutSubtitle': 'Notre histoire',
                    'aboutText1': 'Fondée en 2023, l\'Association ANSFAL POUR LA COOPÉRATION ET LE DÉVELOPPEMENT ET L\'ENVIRONNEMENT est née de la conviction que le développement humain et la protection environnementale doivent aller de pair.',
                    'aboutText2': 'Notre nom \'ANSFAL\' symbolise notre engagement pour un avenir meilleur, basé sur la solidarité, le développement durable et la préservation de notre environnement.',
                    
                    // Projects
                    'projectTitle1': 'Protection des Forêts',
                    'projectDesc1': 'Campagne de reboisement et sensibilisation à la protection des écosystèmes forestiers.',
                    
                    // Contact
                    'contactAddress': 'Maroc',
                    'contactPhone': '+212 6 12 34 56 78',
                    'contactEmail': 'contact@ansfal.org',
                    
                    // Navigation
                    'navHome': 'Accueil',
                    'navAbout': 'À propos',
                    'navGallery': 'Galerie',
                    'navVideos': 'Vidéos',
                    'navProjects': 'Projets',
                    'navPublications': 'Publications',
                    'navComments': 'Commentaires',
                    'navContact': 'Contact',
                    
                    // Boutons
                    'btnDiscover': 'Découvrir nos actions',
                    'btnGallery': 'Galerie',
                    'btnComments': 'Commentaires',
                    'btnView': 'Voir',
                    'btnDownload': 'Télécharger',
                    'btnSubmitComment': 'Publier le commentaire',
                    
                    // Footer
                    'followUs': 'Suivez-nous',
                    'copyright': '© 2024 Association ANSFAL. Tous droits réservés.',
                    
                    // Messages du système
                    'visitorsLabel': 'Visiteurs:',
                    'onlineLabel': 'En ligne:',
                    'lastVisitLabel': 'Dernière visite:',
                    
                    // Upload
                    'uploadFromComputer': 'Depuis votre ordinateur',
                    'uploadFromURL': 'Depuis une URL',
                    'dragDrop': 'Glissez-déposez des fichiers ici ou cliquez pour parcourir',
                    'supportedFormats': 'Formats supportés: JPG, PNG, GIF, PDF, DOC, MP4, AVI, MOV, MP3',
                    'maxSize': 'Taille max: 50MB',
                    'urlPlaceholder': 'https://exemple.com/image.jpg',
                    'preview': 'Aperçu',
                    'addToLibrary': 'Ajouter à la bibliothèque',
                    'upload': 'Télécharger',
                    
                    // Admin
                    'adminMode': 'Mode Administrateur',
                    'adminSub': 'Modification du contenu activée',
                    'saveBtn': 'Sauvegarder',
                    'libraryBtn': 'Bibliothèque',
                    'commentsBtn': 'Commentaires',
                    'usersBtn': 'Gestion Utilisateurs',
                    'changePassBtn': 'Changer mot de passe',
                    'logoutBtn': 'Déconnexion',
                    'loginTitle': 'Connexion Administrateur',
                    'passwordPlaceholder': 'Mot de passe administrateur',
                    'loginBtn': 'Se connecter',
                    'cancelBtn': 'Annuler',
                    'defaultPassword': 'admin123',
                    'changePassMsg': 'Changez-le après la première connexion!',
                    
                    // Webmaster
                    'webmasterMode': 'Mode Webmaster',
                    'webmasterSub': 'Gestion des médias activée',
                    'webmasterLibraryBtn': 'Bibliothèque Média',
                    'uploadBtn': 'Uploader Fichiers',
                    'webmasterCommentsBtn': 'Modérer Commentaires',
                    'webmasterChangePassBtn': 'Changer mot de passe',
                    'webmasterLogoutBtn': 'Déconnexion',
                    'webmasterLoginTitle': 'Connexion Webmaster',
                    'webmasterPasswordPlaceholder': 'Mot de passe webmaster',
                    'webmasterLoginBtn': 'Se connecter',
                    
                    // Messages d'ajout
                    'addImage': 'Ajouter une image',
                    'addVideo': 'Ajouter une vidéo',
                    'addProject': 'Ajouter un projet',
                    'addPublication': 'Ajouter une publication',
                    'enterImageUrl': 'Entrez l\'URL de l\'image:',
                    'enterVideoUrl': 'Entrez l\'URL de la vidéo YouTube:',
                    'enterProjectTitle': 'Entrez le titre du projet:',
                    'enterProjectDesc': 'Entrez la description du projet:',
                    'enterPubTitle': 'Entrez le titre de la publication:',
                    'enterPubDesc': 'Entrez la description de la publication:',
                    'selectPubType': 'Sélectionnez le type de publication:',
                    'report': 'Rapport',
                    'article': 'Article',
                    'brochure': 'Brochure',
                    'other': 'Autre'
                },
                'ar': {
                    // Titres de section
                    'aboutTitle': 'عن أنسفال',
                    'galleryTitle': 'معرض الصور',
                    'videosTitle': 'مقاطع الفيديو',
                    'projectsTitle': 'مشاريعنا',
                    'publicationsTitle': 'المنشورات',
                    'commentsTitle': 'التعليقات',
                    'contactTitle': 'اتصل بنا',
                    
                    // Logo
                    'siteTitle': 'جمعية أنسفال',
                    'siteSubtitle': 'التعاون، التنمية والبيئة',
                    
                    // Hero section
                    'heroTitle': 'أنسفال',
                    'heroSubtitle': 'جمعية التعاون والتنمية والبيئة',
                    'heroText': 'تعمل من أجل التنمية المستدامة، والتعاون  وحماية البيئة منذ 2023.',
                    
                    // About section
                    'aboutSubtitle': 'تاريخنا',
                    'aboutText1': 'تأسست في عام 2023، جمعية أنسفال للتعاون والتنمية والبيئة ولدت من قناعة بأن التنمية البشرية وحماية البيئة يجب أن يسيرا جنباً إلى جنب.',
                    'aboutText2': 'اسمنا \'أنسفال\' يرمز لالتزامنا بمستقبل أفضل، يقوم على التضامن والتنمية المستدامة والحفاظ على بيئتنا.',
                    
                    // Projects
                    'projectTitle1': 'حماية الغابات',
                    'projectDesc1': 'حملة التشجير والتوعية بحماية النظم البيئية للغابات.',
                    
                    // Contact
                    'contactAddress': 'المغرب',
                    'contactPhone': '212 6 12 34 56 78+',
                    'contactEmail': 'contact@ansfal.org',
                    
                    // Navigation
                    'navHome': 'الرئيسية',
                    'navAbout': 'عن الجمعية',
                    'navGallery': 'المعرض',
                    'navVideos': 'فيديوهات',
                    'navProjects': 'المشاريع',
                    'navPublications': 'المنشورات',
                    'navComments': 'التعليقات',
                    'navContact': 'اتصل',
                    
                    // Boutons
                    'btnDiscover': 'اكتشف أنشطتنا',
                    'btnGallery': 'المعرض',
                    'btnComments': 'التعليقات',
                    'btnView': 'عرض',
                    'btnDownload': 'تحميل',
                    'btnSubmitComment': 'نشر التعليق',
                    
                    // Labels
                    'commentNamePlaceholder': 'اسمك',
                    'commentTextPlaceholder': 'تعليقك',
                    
                    // Footer
                    'followUs': 'تابعونا',
                    'copyright': '© 2024 جمعية أنسفال. جميع الحقوق محفوظة.',
                    
                    // Messages du système
                    'visitorsLabel': 'الزوار:',
                    'onlineLabel': 'متصل الآن:',
                    'lastVisitLabel': 'آخر زيارة:',
                    
                    // Upload
                    'uploadFromComputer': 'من جهاز الكمبيوتر',
                    'uploadFromURL': 'من رابط إنترنت',
                    'dragDrop': 'اسحب وأفلت ملفات هنا أو انقر للتصفح',
                    'supportedFormats': 'الصيغ المدعومة: JPG, PNG, GIF, PDF, DOC, MP4, AVI, MOV, MP3',
                    'maxSize': 'الحد الأقصى للحجم: 50 ميجابايت',
                    'urlPlaceholder': 'https://example.com/image.jpg',
                    'preview': 'معاينة',
                    'addToLibrary': 'إضافة إلى المكتبة',
                    'upload': 'تحميل',
                    
                    // Admin
                    'adminMode': 'وضع المدير',
                    'adminSub': 'تم تفعيل تعديل المحتوى',
                    'saveBtn': 'حفظ',
                    'libraryBtn': 'المكتبة',
                    'commentsBtn': 'التعليقات',
                    'usersBtn': 'إدارة المستخدمين',
                    'changePassBtn': 'تغيير كلمة المرور',
                    'logoutBtn': 'تسجيل الخروج',
                    'loginTitle': 'تسجيل دخول المدير',
                    'passwordPlaceholder': 'كلمة مرور المدير',
                    'loginBtn': 'تسجيل الدخول',
                    'cancelBtn': 'إلغاء',
                    'defaultPassword': 'admin123',
                    'changePassMsg': 'قم بتغييره بعد أول تسجيل دخول!',
                    
                    // Webmaster
                    'webmasterMode': 'وضع ويبماستر',
                    'webmasterSub': 'تم تفعيل إدارة الوسائط',
                    'webmasterLibraryBtn': 'مكتبة الوسائط',
                    'uploadBtn': 'رفع ملفات',
                    'webmasterCommentsBtn': 'التحكم في التعليقات',
                    'webmasterChangePassBtn': 'تغيير كلمة المرور',
                    'webmasterLogoutBtn': 'تسجيل الخروج',
                    'webmasterLoginTitle': 'تسجيل دخول ويبماستر',
                    'webmasterPasswordPlaceholder': 'كلمة مرور ويبماستر',
                    'webmasterLoginBtn': 'تسجيل الدخول',
                    
                    // Messages d'ajout
                    'addImage': 'إضافة صورة',
                    'addVideo': 'إضافة فيديو',
                    'addProject': 'إضافة مشروع',
                    'addPublication': 'إضافة منشور',
                    'enterImageUrl': 'أدخل رابط الصورة:',
                    'enterVideoUrl': 'أدخل رابط فيديو يوتيوب:',
                    'enterProjectTitle': 'أدخل عنوان المشروع:',
                    'enterProjectDesc': 'أدخل وصف المشروع:',
                    'enterPubTitle': 'أدخل عنوان المنشور:',
                    'enterPubDesc': 'أدخل وصف المنشور:',
                    'selectPubType': 'اختر نوع المنشور:',
                    'report': 'تقرير',
                    'article': 'مقال',
                    'brochure': 'نشرة',
                    'other': 'أخرى'
                }
            };
            
            // 1. Traduire les éléments éditables par data-id
            if (translations[lang]) {
                Object.keys(translations[lang]).forEach(key => {
                    const element = document.querySelector(`[data-id="${key}"]`);
                    if (element && element.dataset.editable === 'true') {
                        element.textContent = translations[lang][key];
                    }
                });
            }
            
            // 2. Traduire les éléments de navigation
            if (translations[lang]) {
                const navIds = ['navHome', 'navAbout', 'navGallery', 'navVideos', 'navProjects', 'navPublications', 'navComments', 'navContact'];
                navIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && translations[lang][id]) {
                        element.textContent = translations[lang][id];
                    }
                });
            }
            
            // 3. Traduire les boutons dans le héros
            if (translations[lang]) {
                const btnIds = ['btnDiscover', 'btnGallery', 'btnComments', 'btnSubmitComment'];
                btnIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (id === 'btnGallery' && translations[lang][id]) {
                            element.innerHTML = `<i class="fas fa-images"></i> ${translations[lang][id]}`;
                        } else if (id === 'btnComments' && translations[lang][id]) {
                            element.innerHTML = `<i class="fas fa-comments"></i> ${translations[lang][id]}`;
                        } else if (translations[lang][id]) {
                            element.textContent = translations[lang][id];
                        }
                    }
                });
            }
            
            // 4. Traduire les placeholders des commentaires
            if (translations[lang]) {
                const nameInput = document.getElementById('commentNameInput');
                const textInput = document.getElementById('commentTextInput');
                
                if (nameInput && translations[lang]['commentNamePlaceholder']) {
                    nameInput.placeholder = translations[lang]['commentNamePlaceholder'];
                }
                if (textInput && translations[lang]['commentTextPlaceholder']) {
                    textInput.placeholder = translations[lang]['commentTextPlaceholder'];
                }
            }
            
            // 5. Traduire les boutons dans les publications
            if (translations[lang]) {
                const viewTexts = document.querySelectorAll('.btn-view-text');
                const downloadTexts = document.querySelectorAll('.btn-download-text');
                
                viewTexts.forEach(span => {
                    if (translations[lang]['btnView']) {
                        span.textContent = translations[lang]['btnView'];
                    }
                });
                
                downloadTexts.forEach(span => {
                    if (translations[lang]['btnDownload']) {
                        span.textContent = translations[lang]['btnDownload'];
                    }
                });
            }
            
            // 6. Traduire le footer
            if (translations[lang]) {
                const followUs = document.getElementById('followUs');
                const copyright = document.getElementById('copyrightText');
                
                if (followUs && translations[lang]['followUs']) {
                    followUs.textContent = translations[lang]['followUs'];
                }
                if (copyright && translations[lang]['copyright']) {
                    copyright.textContent = translations[lang]['copyright'];
                }
            }
            
            // 7. Traduire le compteur de visiteurs
            if (translations[lang]) {
                const visitorsLabel = document.getElementById('visitorsLabel');
                const onlineLabel = document.getElementById('onlineLabel');
                const lastVisitLabel = document.getElementById('lastVisitLabel');
                
                if (visitorsLabel && translations[lang]['visitorsLabel']) {
                    visitorsLabel.innerHTML = translations[lang]['visitorsLabel'] + ' <span class="visitor-count" id="totalVisitors">' + (visitorStats.total || '0') + '</span>';
                }
                if (onlineLabel && translations[lang]['onlineLabel']) {
                    onlineLabel.innerHTML = translations[lang]['onlineLabel'] + ' <span class="visitor-count" id="onlineVisitors">' + (visitorStats.online || '0') + '</span>';
                }
                if (lastVisitLabel && translations[lang]['lastVisitLabel']) {
                    lastVisitLabel.innerHTML = translations[lang]['lastVisitLabel'] + ' <span id="lastVisit">' + (visitorStats.lastVisit || '--/--/---- --:--:--') + '</span>';
                }
            }
            
            // 8. Traduire la barre admin
            if (translations[lang]) {
                const adminModeText = document.getElementById('adminModeText');
                const saveBtnText = document.getElementById('saveBtnText');
                const libraryBtnText = document.getElementById('libraryBtnText');
                const commentsBtnText = document.getElementById('commentsBtnText');
                const usersBtnText = document.getElementById('usersBtnText');
                const changePassBtnText = document.getElementById('changePassBtnText');
                const logoutBtnText = document.getElementById('logoutBtnText');
                
                if (adminModeText && translations[lang]['adminMode']) {
                    adminModeText.innerHTML = `<strong>${translations[lang]['adminMode']}</strong><br><small>${translations[lang]['adminSub']}</small>`;
                }
                if (saveBtnText && translations[lang]['saveBtn']) {
                    saveBtnText.textContent = translations[lang]['saveBtn'];
                }
                if (libraryBtnText && translations[lang]['libraryBtn']) {
                    libraryBtnText.textContent = translations[lang]['libraryBtn'];
                }
                if (commentsBtnText && translations[lang]['commentsBtn']) {
                    commentsBtnText.textContent = translations[lang]['commentsBtn'];
                }
                if (usersBtnText && translations[lang]['usersBtn']) {
                    usersBtnText.textContent = translations[lang]['usersBtn'];
                }
                if (changePassBtnText && translations[lang]['changePassBtn']) {
                    changePassBtnText.textContent = translations[lang]['changePassBtn'];
                }
                if (logoutBtnText && translations[lang]['logoutBtn']) {
                    logoutBtnText.textContent = translations[lang]['logoutBtn'];
                }
            }
            
            // 9. Traduire la barre webmaster
            if (translations[lang]) {
                const webmasterModeText = document.getElementById('webmasterModeText');
                const webmasterLibraryBtnText = document.getElementById('webmasterLibraryBtnText');
                const uploadBtnText = document.getElementById('uploadBtnText');
                const webmasterCommentsBtnText = document.getElementById('webmasterCommentsBtnText');
                const webmasterChangePassBtnText = document.getElementById('webmasterChangePassBtnText');
                const webmasterLogoutBtnText = document.getElementById('webmasterLogoutBtnText');
                
                if (webmasterModeText && translations[lang]['webmasterMode']) {
                    webmasterModeText.innerHTML = `<strong>${translations[lang]['webmasterMode']}</strong><br><small>${translations[lang]['webmasterSub']}</small>`;
                }
                if (webmasterLibraryBtnText && translations[lang]['webmasterLibraryBtn']) {
                    webmasterLibraryBtnText.textContent = translations[lang]['webmasterLibraryBtn'];
                }
                if (uploadBtnText && translations[lang]['uploadBtn']) {
                    uploadBtnText.textContent = translations[lang]['uploadBtn'];
                }
                if (webmasterCommentsBtnText && translations[lang]['webmasterCommentsBtn']) {
                    webmasterCommentsBtnText.textContent = translations[lang]['webmasterCommentsBtn'];
                }
                if (webmasterChangePassBtnText && translations[lang]['webmasterChangePassBtn']) {
                    webmasterChangePassBtnText.textContent = translations[lang]['webmasterChangePassBtn'];
                }
                if (webmasterLogoutBtnText && translations[lang]['webmasterLogoutBtn']) {
                    webmasterLogoutBtnText.textContent = translations[lang]['webmasterLogoutBtn'];
                }
            }
            
            // 10. Traduire les messages des boutons d'ajout
            const addButtons = document.querySelectorAll('.add-section-btn, .add-item-btn');
            addButtons.forEach(btn => {
                const section = btn.closest('section');
                if (section) {
                    let title = '';
                    if (section.id === 'gallery' && translations[lang]['addImage']) {
                        title = translations[lang]['addImage'];
                    } else if (section.id === 'videos' && translations[lang]['addVideo']) {
                        title = translations[lang]['addVideo'];
                    } else if (section.id === 'projects' && translations[lang]['addProject']) {
                        title = translations[lang]['addProject'];
                    } else if (section.id === 'publications' && translations[lang]['addPublication']) {
                        title = translations[lang]['addPublication'];
                    }
                    if (title) {
                        btn.setAttribute('title', title);
                    }
                }
            });
        }

        // ==================== ACTIVATION DES BARRES ADMIN ====================
        function activateAdminBar() {
            const adminBar = document.getElementById('adminBar');
            const mediaBtn = document.getElementById('mediaLibraryBtn');
            
            if (adminBar && mediaBtn) {
                adminBar.classList.add('active');
                mediaBtn.classList.add('active');
                showEditButtons();
                isAdmin = true;
                
                // Sauvegarder l'état
                localStorage.setItem('ansfal_admin_logged_in', 'true');
                localStorage.setItem('ansfal_admin_session', Date.now().toString());
                
                showNotification(currentLanguage === 'ar' 
                    ? 'تم تفعيل وضع المدير بنجاح!' 
                    : 'Mode administrateur activé avec succès!', 'success');
            }
        }

        function activateWebmasterBar() {
            const webmasterBar = document.getElementById('webmasterBar');
            const mediaBtn = document.getElementById('mediaLibraryBtn');
            
            if (webmasterBar && mediaBtn) {
                webmasterBar.classList.add('active');
                mediaBtn.classList.add('active');
                showUploadButtons();
                isWebmaster = true;
                
                // Sauvegarder l'état
                localStorage.setItem('ansfal_webmaster_logged_in', 'true');
                localStorage.setItem('ansfal_webmaster_session', Date.now().toString());
                
                showNotification(currentLanguage === 'ar' 
                    ? 'تم تفعيل وضع الويبماستر بنجاح!' 
                    : 'Mode webmaster activé avec succès!', 'success');
            }
        }

        // ==================== SYSTÈME D'ADMINISTRATION ====================
        function toggleAdminBar() {
            const adminBar = document.getElementById('adminBar');
            const mediaBtn = document.getElementById('mediaLibraryBtn');
            const isActive = adminBar.classList.toggle('active');
            
            if (isActive) {
                mediaBtn.classList.add('active');
                showEditButtons();
            } else {
                mediaBtn.classList.remove('active');
                hideEditButtons();
            }
        }

        function toggleWebmasterBar() {
            const webmasterBar = document.getElementById('webmasterBar');
            const mediaBtn = document.getElementById('mediaLibraryBtn');
            const isActive = webmasterBar.classList.toggle('active');
            
            if (isActive) {
                mediaBtn.classList.add('active');
                showUploadButtons();
            } else {
                mediaBtn.classList.remove('active');
                hideUploadButtons();
            }
        }

        function showEditButtons() {
            document.querySelectorAll('.edit-btn, .image-edit-btn, .add-section-btn, .add-item-btn, .remove-item-btn').forEach(btn => {
                btn.style.display = 'flex';
            });
        }

        function hideEditButtons() {
            if (!isAdmin && !isWebmaster) {
                document.querySelectorAll('.edit-btn, .image-edit-btn, .add-section-btn, .add-item-btn, .remove-item-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        function showUploadButtons() {
            document.querySelectorAll('.add-section-btn, .add-item-btn, .remove-item-btn').forEach(btn => {
                btn.style.display = 'flex';
            });
        }

        function hideUploadButtons() {
            if (!isAdmin && !isWebmaster) {
                document.querySelectorAll('.add-section-btn, .add-item-btn, .remove-item-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        function editText(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (!element) {
                console.error("Élément non trouvé:", elementId);
                return;
            }
            
            const currentText = element.textContent;
            const newText = prompt(currentLanguage === 'ar' ? 'تعديل النص:' : 'Modifier le texte:', currentText);
            
            if (newText !== null && newText !== currentText) {
                element.textContent = newText;
                saveContentToLocalStorage(elementId, newText);
            }
        }

        function editImage(elementId) {
            const message = currentLanguage === 'ar' ? 'أدخل رابط الصورة الجديدة:' : 'Entrez l\'URL de la nouvelle image:';
            const url = prompt(message);
            if (url) {
                const element = document.querySelector(`[data-id="${elementId}"] img`);
                if (element) {
                    element.src = url;
                    saveContentToLocalStorage(elementId + '_img', url);
                }
            }
        }

        // ==================== GESTION DU CONTENU ====================
        function saveContent() {
            // Collecter tous les contenus éditables
            const editableElements = document.querySelectorAll('[data-editable="true"]');
            editableElements.forEach(element => {
                const id = element.dataset.id;
                if (id) {
                    contentData[id] = element.textContent;
                }
            });
            
            // Sauvegarder les images
            const imageElements = document.querySelectorAll('.image-editable img');
            imageElements.forEach(element => {
                const parent = element.closest('.image-editable');
                if (parent && parent.dataset.id) {
                    contentData[parent.dataset.id + '_img'] = element.src;
                }
            });
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('ansfal_content', JSON.stringify(contentData));
            
            // Sauvegarder les éléments des sections
            saveSectionItems();
            
            // Afficher une notification
            alert(currentLanguage === 'ar' ? 'تم حفظ المحتوى بنجاح!' : 'Contenu sauvegardé avec succès!');
        }

        function loadContentData() {
            const saved = localStorage.getItem('ansfal_content');
            if (saved) {
                try {
                    contentData = JSON.parse(saved);
                    
                    // Appliquer les contenus sauvegardés
                    Object.keys(contentData).forEach(id => {
                        if (id.endsWith('_img')) {
                            // C'est une image
                            const elementId = id.replace('_img', '');
                            const element = document.querySelector(`[data-id="${elementId}"] img`);
                            if (element) {
                                element.src = contentData[id];
                            }
                        } else {
                            // C'est du texte
                            const element = document.querySelector(`[data-id="${id}"]`);
                            if (element && element.dataset.editable === 'true') {
                                element.textContent = contentData[id];
                            }
                        }
                    });
                } catch (e) {
                    console.error("Erreur lors du chargement du contenu:", e);
                }
            }
        }

        function saveContentToLocalStorage(id, content) {
            if (!contentData) contentData = {};
            contentData[id] = content;
            localStorage.setItem('ansfal_content', JSON.stringify(contentData));
        }

        // ==================== FONCTIONS D'AJOUT D'ÉLÉMENTS AVEC UPLOAD ====================
        
        // GALERIE
        function addGalleryItem() {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            // Demander le type d'upload
            const uploadType = confirm(currentLanguage === 'ar' 
                ? 'تريد رفع صورة من جهاز الكمبيوتر؟ (موافق = جهاز الكمبيوتر، إلغاء = رابط إنترنت)'
                : 'Voulez-vous uploader une image depuis votre ordinateur? (OK = ordinateur, Annuler = URL internet)');
            
            if (uploadType) {
                // Upload depuis l'ordinateur - OUVRIR LA MODALE D'UPLOAD
                showSimpleUploadModal('image', function(fileUrl, fileName) {
                    if (fileUrl) {
                        addGalleryItemToGrid(fileUrl, fileName);
                    }
                });
            } else {
                // URL internet
                const message = currentLanguage === 'ar' ? 'أدخل رابط الصورة:' : 'Entrez l\'URL de l\'image:';
                const url = prompt(message, 'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80');
                
                if (url) {
                    addGalleryItemToGrid(url, currentLanguage === 'ar' ? 'صورة من الإنترنت' : 'Image internet');
                }
            }
        }

        function addGalleryItemToGrid(url, title) {
            const galleryGrid = document.getElementById('galleryGrid');
            const newId = 'gallery' + Date.now();
            
            const newItem = document.createElement('div');
            newItem.className = 'gallery-item image-editable';
            newItem.setAttribute('data-id', newId);
            newItem.innerHTML = `
                <img src="${url}" alt="${title}">
                <button class="image-edit-btn" onclick="editImage('${newId}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="add-item-btn" onclick="addGalleryItem()" title="${currentLanguage === 'ar' ? 'إضافة صورة' : 'Ajouter une image'}">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="remove-item-btn" onclick="removeGalleryItem('${newId}')" title="${currentLanguage === 'ar' ? 'حذف هذه الصورة' : 'Supprimer cette image'}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            galleryGrid.appendChild(newItem);
            galleryItems.push({ id: newId, url: url, title: title });
            saveSectionItems();
            checkEmptyStates();
            
            // Ajouter à la bibliothèque média
            addToMediaLibrary(url, title, 'image');
        }

        function removeGalleryItem(id) {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذه الصورة؟'
                : 'Êtes-vous sûr de vouloir supprimer cette image?';
            
            if (confirm(confirmMsg)) {
                const element = document.querySelector(`[data-id="${id}"]`);
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                    galleryItems = galleryItems.filter(item => item.id !== id);
                    saveSectionItems();
                    checkEmptyStates();
                }
            }
        }

        // VIDÉOS
        function addVideoItem() {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            // Demander le type d'upload
            const uploadType = confirm(currentLanguage === 'ar' 
                ? 'تريد رفع فيديو من جهاز الكمبيوتر؟ (موافق = جهاز الكمبيوتر، إلغاء = رابط يوتيوب)'
                : 'Voulez-vous uploader une vidéo depuis votre ordinateur? (OK = ordinateur, Annuler = YouTube)');
            
            if (uploadType) {
                // Upload depuis l'ordinateur
                showSimpleUploadModal('video', function(fileUrl, fileName) {
                    if (fileUrl) {
                        addVideoItemToGrid(fileUrl, fileName, 'local');
                    }
                });
            } else {
                // URL YouTube
                const message = currentLanguage === 'ar' 
                    ? 'أدخل رابط فيديو يوتيوب (مثال: https://www.youtube.com/embed/معرف_الفيديو):'
                    : 'Entrez l\'URL de la vidéo YouTube (ex: https://www.youtube.com/embed/VIDEO_ID):';
                const url = prompt(message, 'https://www.youtube.com/embed/dQw4w9WgXcQ');
                
                if (url) {
                    addVideoItemToGrid(url, currentLanguage === 'ar' ? 'فيديو يوتيوب' : 'Vidéo YouTube', 'youtube');
                }
            }
        }

        function addVideoItemToGrid(url, title, type) {
            const videoContainer = document.getElementById('videoContainer');
            const videoId = 'video' + Date.now();
            
            const newItem = document.createElement('div');
            newItem.className = 'video-item';
            
            if (type === 'youtube') {
                newItem.innerHTML = `
                    <div class="youtube-embed">
                        <iframe src="${url}" allowfullscreen></iframe>
                    </div>
                    <button class="add-item-btn" onclick="addVideoItem()" title="${currentLanguage === 'ar' ? 'إضافة فيديو' : 'Ajouter une vidéo'}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeVideoItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا الفيديو' : 'Supprimer cette vidéo'}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                newItem.innerHTML = `
                    <div class="youtube-embed">
                        <video controls style="width: 100%; height: 100%;">
                            <source src="${url}" type="video/mp4">
                            ${currentLanguage === 'ar' ? 'متصفحك لا يدعم تشغيل الفيديو' : 'Votre navigateur ne supporte pas la lecture vidéo'}
                        </video>
                    </div>
                    <button class="add-item-btn" onclick="addVideoItem()" title="${currentLanguage === 'ar' ? 'إضافة فيديو' : 'Ajouter une vidéo'}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeVideoItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا الفيديو' : 'Supprimer cette vidéo'}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            videoContainer.appendChild(newItem);
            videoItems.push({ id: videoId, url: url, title: title, type: type });
            saveSectionItems();
            checkEmptyStates();
            
            // Ajouter à la bibliothèque média
            if (type !== 'youtube') {
                addToMediaLibrary(url, title, 'video');
            }
        }

        function removeVideoItem(button) {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا الفيديو؟'
                : 'Êtes-vous sûr de vouloir supprimer cette vidéo?';
            
            if (confirm(confirmMsg)) {
                const videoItem = button.closest('.video-item');
                if (videoItem && videoItem.parentNode) {
                    const videoId = videoItem.querySelector('iframe') ? videoItem.querySelector('iframe').src : 
                                   videoItem.querySelector('video') ? videoItem.querySelector('video').querySelector('source').src : '';
                    videoItems = videoItems.filter(item => item.url !== videoId);
                    videoItem.parentNode.removeChild(videoItem);
                    saveSectionItems();
                    checkEmptyStates();
                }
            }
        }

        // PROJETS
        function addProjectItem() {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const titleMsg = currentLanguage === 'ar' ? 'أدخل عنوان المشروع:' : 'Entrez le titre du projet:';
            const descMsg = currentLanguage === 'ar' ? 'أدخل وصف المشروع:' : 'Entrez la description du projet:';
            
            const title = prompt(titleMsg, currentLanguage === 'ar' ? 'مشروع جديد' : 'Nouveau projet');
            if (!title) return;
            
            const description = prompt(descMsg, currentLanguage === 'ar' ? 'وصف المشروع' : 'Description du projet');
            if (!description) return;
            
            // Demander le type d'upload pour l'image
            const uploadType = confirm(currentLanguage === 'ar' 
                ? 'تريد رفع صورة من جهاز الكمبيوتر؟ (موافق = جهاز الكمبيوتر، إلغاء = رابط إنترنت)'
                : 'Voulez-vous uploader une image depuis votre ordinateur? (OK = ordinateur, Annuler = URL internet)');
            
            if (uploadType) {
                // Upload depuis l'ordinateur
                showSimpleUploadModal('image', function(fileUrl, fileName) {
                    if (fileUrl) {
                        addProjectItemToGrid(title, description, fileUrl, fileName);
                    }
                });
            } else {
                // URL internet
                const imageMsg = currentLanguage === 'ar' ? 'أدخل رابط صورة المشروع:' : 'Entrez l\'URL de l\'image du projet:';
                const imageUrl = prompt(imageMsg, 'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80');
                if (!imageUrl) return;
                
                addProjectItemToGrid(title, description, imageUrl, currentLanguage === 'ar' ? 'صورة المشروع' : 'Image projet');
            }
        }

        function addProjectItemToGrid(title, description, imageUrl, imageTitle) {
            const projectsContainer = document.getElementById('projectsContainer');
            const projectId = 'project' + Date.now();
            const titleId = 'projectTitle' + projectItems.length + 2;
            const descId = 'projectDesc' + projectItems.length + 2;
            const imgId = 'projectImg' + projectItems.length + 2;
            
            const newItem = document.createElement('div');
            newItem.className = 'project-card';
            newItem.innerHTML = `
                <div class="project-img image-editable" data-id="${imgId}">
                    <img src="${imageUrl}" alt="${title}">
                    <button class="image-edit-btn" onclick="editImage('${imgId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="project-info">
                    <h3 class="editable" data-id="${titleId}" data-editable="true">${title}</h3>
                    <button class="edit-btn" onclick="editText('${titleId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <p class="editable" data-id="${descId}" data-editable="true">${description}</p>
                    <button class="edit-btn" onclick="editText('${descId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <button class="add-item-btn" onclick="addProjectItem()" title="${currentLanguage === 'ar' ? 'إضافة مشروع' : 'Ajouter un projet'}">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="remove-item-btn" onclick="removeProjectItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا المشروع' : 'Supprimer ce projet'}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            projectsContainer.appendChild(newItem);
            projectItems.push({ 
                id: projectId, 
                title: title, 
                description: description, 
                imageUrl: imageUrl,
                titleId: titleId,
                descId: descId,
                imgId: imgId
            });
            saveSectionItems();
            checkEmptyStates();
            
            // Ajouter à la bibliothèque média
            addToMediaLibrary(imageUrl, imageTitle || title, 'image');
        }

        function removeProjectItem(button) {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا المشروع؟'
                : 'Êtes-vous sûr de vouloir supprimer ce projet?';
            
            if (confirm(confirmMsg)) {
                const projectItem = button.closest('.project-card');
                if (projectItem && projectItem.parentNode) {
                    const title = projectItem.querySelector('h3').textContent;
                    projectItems = projectItems.filter(item => item.title !== title);
                    projectItem.parentNode.removeChild(projectItem);
                    saveSectionItems();
                    checkEmptyStates();
                }
            }
        }

        // PUBLICATIONS
        function addPublicationItem() {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const titleMsg = currentLanguage === 'ar' ? 'أدخل عنوان المنشور:' : 'Entrez le titre de la publication:';
            const descMsg = currentLanguage === 'ar' ? 'أدخل وصف المنشور:' : 'Entrez la description de la publication:';
            const typeMsg = currentLanguage === 'ar' ? 'اختر نوع المنشور:' : 'Sélectionnez le type de publication:';
            
            const title = prompt(titleMsg, currentLanguage === 'ar' ? 'منشور جديد' : 'Nouvelle publication');
            if (!title) return;
            
            const description = prompt(descMsg, currentLanguage === 'ar' ? 'وصف المنشور' : 'Description de la publication');
            if (!description) return;
            
            const typeOptions = currentLanguage === 'ar' 
                ? ['تقرير', 'مقال', 'نشرة', 'أخرى']
                : ['Rapport', 'Article', 'Brochure', 'Autre'];
            const type = prompt(`${typeMsg}\n${typeOptions.join(', ')}`, typeOptions[0]);
            
            // Demander le type d'upload pour le fichier
            const uploadType = confirm(currentLanguage === 'ar' 
                ? 'تريد رفع ملف من جهاز الكمبيوتر؟ (موافق = جهاز الكمبيوتر، إلغاء = رابط إنترنت)'
                : 'Voulez-vous uploader un fichier depuis votre ordinateur? (OK = ordinateur, Annuler = URL internet)');
            
            if (uploadType) {
                // Upload depuis l'ordinateur
                showSimpleUploadModal('document', function(fileUrl, fileName) {
                    if (fileUrl) {
                        addPublicationItemToGrid(title, description, type, fileUrl, fileName);
                    }
                });
            } else {
                // URL internet
                const fileMsg = currentLanguage === 'ar' ? 'أدخل رابط الملف:' : 'Entrez l\'URL du fichier:';
                const fileUrl = prompt(fileMsg, 'https://example.com/document.pdf');
                if (!fileUrl) return;
                
                addPublicationItemToGrid(title, description, type, fileUrl, currentLanguage === 'ar' ? 'ملف من الإنترنت' : 'Fichier internet');
            }
        }

        function addPublicationItemToGrid(title, description, type, fileUrl, fileName) {
            const publicationsGrid = document.getElementById('publicationsGrid');
            const pubId = 'pub' + Date.now();
            const titleId = 'pubTitle' + publicationItems.length + 2;
            const descId = 'pubDesc' + publicationItems.length + 2;
            const date = new Date().toLocaleDateString();
            
            const newItem = document.createElement('div');
            newItem.className = 'publication-card';
            newItem.innerHTML = `
                <div class="publication-header">
                    <span class="publication-type">${type || 'Rapport'}</span>
                    <span class="publication-date">${date}</span>
                </div>
                <div class="publication-content">
                    <h3 class="publication-title editable" data-id="${titleId}" data-editable="true">${title}</h3>
                    <button class="edit-btn" onclick="editText('${titleId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <p class="publication-description editable" data-id="${descId}" data-editable="true">${description}</p>
                    <button class="edit-btn" onclick="editText('${descId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <div class="publication-actions">
                        <a href="${fileUrl}" class="btn-view" target="_blank">
                            <i class="fas fa-eye"></i> <span class="btn-view-text">${currentLanguage === 'ar' ? 'عرض' : 'Voir'}</span>
                        </a>
                        <a href="${fileUrl}" class="btn-download" download>
                            <i class="fas fa-download"></i> <span class="btn-download-text">${currentLanguage === 'ar' ? 'تحميل' : 'Télécharger'}</span>
                        </a>
                    </div>
                </div>
                <button class="add-item-btn" onclick="addPublicationItem()" title="${currentLanguage === 'ar' ? 'إضافة منشور' : 'Ajouter une publication'}">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="remove-item-btn" onclick="removePublicationItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا المنشور' : 'Supprimer cette publication'}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            publicationsGrid.appendChild(newItem);
            publicationItems.push({ 
                id: pubId, 
                title: title, 
                description: description, 
                type: type || 'Rapport',
                date: date,
                fileUrl: fileUrl,
                fileName: fileName,
                titleId: titleId,
                descId: descId
            });
            saveSectionItems();
            checkEmptyStates();
            
            // Ajouter à la bibliothèque média
            addToMediaLibrary(fileUrl, fileName || title, getFileTypeFromUrl(fileUrl));
        }

        function removePublicationItem(button) {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا المنشور؟'
                : 'Êtes-vous sûr de vouloir supprimer cette publication?';
            
            if (confirm(confirmMsg)) {
                const publicationItem = button.closest('.publication-card');
                if (publicationItem && publicationItem.parentNode) {
                    const title = publicationItem.querySelector('h3').textContent;
                    publicationItems = publicationItems.filter(item => item.title !== title);
                    publicationItem.parentNode.removeChild(publicationItem);
                    saveSectionItems();
                    checkEmptyStates();
                }
            }
        }

        // À PROPOS
        function addAboutItem() {
            if (!isAdmin) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين' : 'Accès réservé aux administrateurs');
                return;
            }
            
            const text = prompt(currentLanguage === 'ar' ? 'أدخل نصًا جديدًا:' : 'Entrez un nouveau texte:', currentLanguage === 'ar' ? 'نص جديد' : 'Nouveau texte');
            if (text) {
                const aboutText = document.querySelector('.about-text');
                const newParagraph = document.createElement('p');
                const paraId = 'aboutText' + (document.querySelectorAll('.about-text p').length + 1);
                
                newParagraph.className = 'editable';
                newParagraph.setAttribute('data-id', paraId);
                newParagraph.setAttribute('data-editable', 'true');
                newParagraph.textContent = text;
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-btn';
                editButton.innerHTML = '<i class="fas fa-edit"></i>';
                editButton.onclick = function() { editText(paraId); };
                
                newParagraph.appendChild(editButton);
                aboutText.appendChild(newParagraph);
                
                saveContentToLocalStorage(paraId, text);
            }
        }

        // ==================== MODALE D'UPLOAD SIMPLE ====================
        function showSimpleUploadModal(fileType, callback) {
            const modalId = 'simpleUploadModal';
            let modal = document.getElementById(modalId);
            
            if (modal) {
                modal.parentNode.removeChild(modal);
            }
            
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = modalId;
            
            const fileTypeName = currentLanguage === 'ar' 
                ? (fileType === 'image' ? 'صورة' : fileType === 'video' ? 'فيديو' : 'ملف')
                : (fileType === 'image' ? 'image' : fileType === 'video' ? 'vidéo' : 'fichier');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h3><i class="fas fa-cloud-upload-alt"></i> ${currentLanguage === 'ar' ? `رفع ${fileTypeName}` : `Uploader une ${fileTypeName}`}</h3>
                    
                    <div class="file-input-container" id="simpleFileDropZone">
                        <label class="file-input-label">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                            <h4>${currentLanguage === 'ar' ? 'اسحب وأفلت ملف هنا أو انقر للتصفح' : 'Glissez-déposez un fichier ici ou cliquez pour parcourir'}</h4>
                            <div style="margin-top: 20px;">
                                <button type="button" class="btn" onclick="document.getElementById('simpleFileInput').click()" style="background-color: var(--primary);">
                                    <i class="fas fa-folder-open"></i> ${currentLanguage === 'ar' ? 'تصفح الملفات' : 'Parcourir les fichiers'}
                                </button>
                            </div>
                            <input type="file" class="file-input" id="simpleFileInput" accept="${getAcceptForFileType(fileType)}" style="display: none;">
                        </label>
                        <div class="file-info">
                            <small>${getFileTypeInfo(fileType)}</small><br>
                            <small>${currentLanguage === 'ar' ? 'الحد الأقصى للحجم: 50 ميجابايت' : 'Taille max: 50MB'}</small>
                        </div>
                    </div>
                    
                    <div class="upload-progress" id="simpleUploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="simpleProgressFill"></div>
                        </div>
                        <div class="progress-text" id="simpleProgressText">0%</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="closeModal('${modalId}')" style="background-color: var(--dark); margin-right: 10px;">
                            <i class="fas fa-times"></i> ${currentLanguage === 'ar' ? 'إلغاء' : 'Annuler'}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Stocker le callback
            window.simpleUploadCallback = callback;
            window.simpleUploadFileType = fileType;
            
            // Initialiser les événements
            setTimeout(() => {
                const fileInput = document.getElementById('simpleFileInput');
                const dropZone = document.getElementById('simpleFileDropZone');
                
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleSimpleFileUpload(e, fileType);
                    });
                }
                
                if (dropZone) {
                    dropZone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.add('dragover');
                    });
                    
                    dropZone.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('dragover');
                    });
                    
                    dropZone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            // Créer un nouvel événement change
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(files[0]);
                            fileInput.files = dataTransfer.files;
                            
                            const event = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(event);
                        }
                    });
                }
            }, 100);
            
            modal.classList.add('active');
        }

        function handleSimpleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Vérifier la taille (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert(currentLanguage === 'ar' 
                    ? 'الملف كبير جدًا! الحد الأقصى 50 ميجابايت' 
                    : 'Fichier trop grand! Maximum 50MB');
                return;
            }
            
            // Vérifier le type de fichier
            if (fileType === 'image' && !file.type.startsWith('image/')) {
                alert(currentLanguage === 'ar' 
                    ? 'الرجاء اختيار ملف صورة (JPG, PNG, GIF)' 
                    : 'Veuillez choisir un fichier image (JPG, PNG, GIF)');
                return;
            }
            
            if (fileType === 'video' && !file.type.startsWith('video/')) {
                alert(currentLanguage === 'ar' 
                    ? 'الرجاء اختيار ملف فيديو (MP4, AVI, MOV)' 
                    : 'Veuillez choisir un fichier vidéo (MP4, AVI, MOV)');
                return;
            }
            
            if (fileType === 'document' && !file.type.includes('pdf') && !file.type.includes('document') && !file.name.match(/\.(pdf|doc|docx|txt)$/i)) {
                alert(currentLanguage === 'ar' 
                    ? 'الرجاء اختيار ملف PDF أو مستند نصي' 
                    : 'Veuillez choisir un fichier PDF ou document texte');
                return;
            }
            
            // Afficher la progression
            const progress = document.getElementById('simpleUploadProgress');
            const progressFill = document.getElementById('simpleProgressFill');
            const progressText = document.getElementById('simpleProgressText');
            
            progress.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            
            // Lire le fichier
            const reader = new FileReader();
            
            reader.onloadstart = function() {
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
            };
            
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentLoaded = Math.round((e.loaded / e.total) * 100);
                    progressFill.style.width = percentLoaded + '%';
                    progressText.textContent = percentLoaded + '%';
                }
            };
            
            reader.onload = function(e) {
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
                
                // Fermer la modale après un court délai
                setTimeout(() => {
                    closeModal('simpleUploadModal');
                    
                    // Appeler le callback avec l'URL du fichier
                    if (window.simpleUploadCallback) {
                        window.simpleUploadCallback(e.target.result, file.name);
                    }
                    
                    // Nettoyer
                    delete window.simpleUploadCallback;
                    delete window.simpleUploadFileType;
                }, 500);
            };
            
            reader.onerror = function() {
                alert(currentLanguage === 'ar' 
                    ? 'خطأ في قراءة الملف' 
                    : 'Erreur de lecture du fichier');
                progress.style.display = 'none';
            };
            
            reader.readAsDataURL(file);
        }

        function getAcceptForFileType(fileType) {
            switch(fileType) {
                case 'image':
                    return 'image/*';
                case 'video':
                    return 'video/*';
                case 'document':
                    return '.pdf,.doc,.docx,.txt';
                default:
                    return '*/*';
            }
        }

        function getFileTypeInfo(fileType) {
            if (currentLanguage === 'ar') {
                switch(fileType) {
                    case 'image':
                        return 'الصيغ المدعومة: JPG, PNG, GIF, WEBP';
                    case 'video':
                        return 'الصيغ المدعومة: MP4, AVI, MOV, WEBM';
                    case 'document':
                        return 'الصيغ المدعومة: PDF, DOC, DOCX, TXT';
                    default:
                        return 'جميع أنواع الملفات';
                }
            } else {
                switch(fileType) {
                    case 'image':
                        return 'Formats supportés: JPG, PNG, GIF, WEBP';
                    case 'video':
                        return 'Formats supportés: MP4, AVI, MOV, WEBM';
                    case 'document':
                        return 'Formats supportés: PDF, DOC, DOCX, TXT';
                    default:
                        return 'Tous types de fichiers';
                }
            }
        }

        function getFileTypeFromUrl(url) {
            if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) return 'image';
            if (url.match(/\.(mp4|avi|mov|webm)$/i)) return 'video';
            if (url.match(/\.(pdf)$/i)) return 'pdf';
            if (url.match(/\.(doc|docx)$/i)) return 'document';
            if (url.match(/\.(txt)$/i)) return 'text';
            return 'file';
        }

        // ==================== GESTION DES ÉTATS VIDES ====================
        function checkEmptyStates() {
            // Galerie
            const galleryGrid = document.getElementById('galleryGrid');
            const galleryEmptyState = document.getElementById('galleryEmptyState');
            if (galleryGrid.children.length === 0) {
                galleryEmptyState.style.display = 'block';
            } else {
                galleryEmptyState.style.display = 'none';
            }
            
            // Vidéos
            const videoContainer = document.getElementById('videoContainer');
            const videosEmptyState = document.getElementById('videosEmptyState');
            if (videoContainer.children.length === 0) {
                videosEmptyState.style.display = 'block';
            } else {
                videosEmptyState.style.display = 'none';
            }
            
            // Projets
            const projectsContainer = document.getElementById('projectsContainer');
            const projectsEmptyState = document.getElementById('projectsEmptyState');
            if (projectsContainer.children.length === 0) {
                projectsEmptyState.style.display = 'block';
            } else {
                projectsEmptyState.style.display = 'none';
            }
            
            // Publications
            const publicationsGrid = document.getElementById('publicationsGrid');
            const publicationsEmptyState = document.getElementById('publicationsEmptyState');
            if (publicationsGrid.children.length === 0) {
                publicationsEmptyState.style.display = 'block';
            } else {
                publicationsEmptyState.style.display = 'none';
            }
        }

        // ==================== SAUVEGARDE/CHARGEMENT DES ÉLÉMENTS ====================
        function saveSectionItems() {
            const sectionData = {
                gallery: galleryItems,
                videos: videoItems,
                projects: projectItems,
                publications: publicationItems
            };
            localStorage.setItem('ansfal_section_items', JSON.stringify(sectionData));
        }

        function loadSectionItems() {
            const saved = localStorage.getItem('ansfal_section_items');
            if (saved) {
                try {
                    const sectionData = JSON.parse(saved);
                    
                    // Charger les éléments de chaque section
                    galleryItems = sectionData.gallery || [];
                    videoItems = sectionData.videos || [];
                    projectItems = sectionData.projects || [];
                    publicationItems = sectionData.publications || [];
                    
                    // Reconstruire l'interface
                    rebuildSectionInterfaces();
                    
                } catch (e) {
                    console.error("Erreur lors du chargement des éléments:", e);
                }
            }
        }
        
        function rebuildSectionInterfaces() {
            // Reconstruire la galerie
            const galleryGrid = document.getElementById('galleryGrid');
            galleryGrid.innerHTML = '';
            galleryItems.forEach(item => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item image-editable';
                galleryItem.setAttribute('data-id', item.id);
                galleryItem.innerHTML = `
                    <img src="${item.url}" alt="${item.title}">
                    <button class="image-edit-btn" onclick="editImage('${item.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="add-item-btn" onclick="addGalleryItem()" title="${currentLanguage === 'ar' ? 'إضافة صورة' : 'Ajouter une image'}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeGalleryItem('${item.id}')" title="${currentLanguage === 'ar' ? 'حذف هذه الصورة' : 'Supprimer cette image'}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                galleryGrid.appendChild(galleryItem);
            });
            
            // Reconstruire les vidéos
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.innerHTML = '';
            videoItems.forEach(item => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                
                if (item.type === 'youtube') {
                    videoItem.innerHTML = `
                        <div class="youtube-embed">
                            <iframe src="${item.url}" allowfullscreen></iframe>
                        </div>
                        <button class="add-item-btn" onclick="addVideoItem()" title="${currentLanguage === 'ar' ? 'إضافة فيديو' : 'Ajouter une vidéo'}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="remove-item-btn" onclick="removeVideoItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا الفيديو' : 'Supprimer cette vidéo'}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    videoItem.innerHTML = `
                        <div class="youtube-embed">
                            <video controls style="width: 100%; height: 100%;">
                                <source src="${item.url}" type="video/mp4">
                                ${currentLanguage === 'ar' ? 'متصفحك لا يدعم تشغيل الفيديو' : 'Votre navigateur ne supporte pas la lecture vidéo'}
                            </video>
                        </div>
                        <button class="add-item-btn" onclick="addVideoItem()" title="${currentLanguage === 'ar' ? 'إضافة فيديو' : 'Ajouter une vidéo'}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="remove-item-btn" onclick="removeVideoItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا الفيديو' : 'Supprimer cette vidéo'}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }
                videoContainer.appendChild(videoItem);
            });
            
            // Reconstruire les projets
            const projectsContainer = document.getElementById('projectsContainer');
            projectsContainer.innerHTML = '';
            projectItems.forEach(item => {
                const projectItem = document.createElement('div');
                projectItem.className = 'project-card';
                projectItem.innerHTML = `
                    <div class="project-img image-editable" data-id="${item.imgId}">
                        <img src="${item.imageUrl}" alt="${item.title}">
                        <button class="image-edit-btn" onclick="editImage('${item.imgId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="project-info">
                        <h3 class="editable" data-id="${item.titleId}" data-editable="true">${item.title}</h3>
                        <button class="edit-btn" onclick="editText('${item.titleId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <p class="editable" data-id="${item.descId}" data-editable="true">${item.description}</p>
                        <button class="edit-btn" onclick="editText('${item.descId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <button class="add-item-btn" onclick="addProjectItem()" title="${currentLanguage === 'ar' ? 'إضافة مشروع' : 'Ajouter un projet'}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removeProjectItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا المشروع' : 'Supprimer ce projet'}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                projectsContainer.appendChild(projectItem);
            });
            
            // Reconstruire les publications
            const publicationsGrid = document.getElementById('publicationsGrid');
            publicationsGrid.innerHTML = '';
            publicationItems.forEach(item => {
                const publicationItem = document.createElement('div');
                publicationItem.className = 'publication-card';
                publicationItem.innerHTML = `
                    <div class="publication-header">
                        <span class="publication-type">${item.type}</span>
                        <span class="publication-date">${item.date}</span>
                    </div>
                    <div class="publication-content">
                        <h3 class="publication-title editable" data-id="${item.titleId}" data-editable="true">${item.title}</h3>
                        <button class="edit-btn" onclick="editText('${item.titleId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <p class="publication-description editable" data-id="${item.descId}" data-editable="true">${item.description}</p>
                        <button class="edit-btn" onclick="editText('${item.descId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <div class="publication-actions">
                            <a href="${item.fileUrl}" class="btn-view" target="_blank">
                                <i class="fas fa-eye"></i> <span class="btn-view-text">${currentLanguage === 'ar' ? 'عرض' : 'Voir'}</span>
                            </a>
                            <a href="${item.fileUrl}" class="btn-download" download>
                                <i class="fas fa-download"></i> <span class="btn-download-text">${currentLanguage === 'ar' ? 'تحميل' : 'Télécharger'}</span>
                            </a>
                        </div>
                    </div>
                    <button class="add-item-btn" onclick="addPublicationItem()" title="${currentLanguage === 'ar' ? 'إضافة منشور' : 'Ajouter une publication'}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="remove-item-btn" onclick="removePublicationItem(this)" title="${currentLanguage === 'ar' ? 'حذف هذا المنشور' : 'Supprimer cette publication'}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                publicationsGrid.appendChild(publicationItem);
            });
            
            checkEmptyStates();
        }

        // ==================== GESTION DES COMMENTAIRES ====================
        function submitComment() {
            const nameInput = document.getElementById('commentNameInput');
            const textInput = document.getElementById('commentTextInput');
            
            const name = nameInput.value.trim();
            const text = textInput.value.trim();
            
            if (!name || !text) {
                alert(currentLanguage === 'ar' 
                    ? 'يرجى إدخال اسمك وتعليقك'
                    : 'Veuillez entrer votre nom et votre commentaire');
                return;
            }
            
            const comment = {
                id: Date.now(),
                name: name,
                text: text,
                date: new Date().toLocaleString(),
                approved: false
            };
            
            pendingComments.push(comment);
            saveComments();
            
            // Réinitialiser les champs
            nameInput.value = '';
            textInput.value = '';
            
            // Afficher un message de confirmation
            alert(currentLanguage === 'ar' 
                ? 'شكراً لتعليقك! سيتم نشره بعد المراجعة.'
                : 'Merci pour votre commentaire! Il sera publié après modération.');
            
            // Mettre à jour le badge
            updateCommentsBadge();
            
            // Si on est admin ou webmaster, afficher le commentaire directement
            if (isAdmin || isWebmaster) {
                approveComment(comment.id);
            }
        }

        function approveComment(commentId) {
            const commentIndex = pendingComments.findIndex(c => c.id === commentId);
            if (commentIndex !== -1) {
                const comment = pendingComments[commentIndex];
                comment.approved = true;
                comment.approvalDate = new Date().toLocaleString();
                
                approvedComments.push(comment);
                pendingComments.splice(commentIndex, 1);
                
                saveComments();
                renderCommentsList();
                updateCommentsBadge();
            }
        }

        function deleteComment(commentId, isPending = false) {
            if (!isAdmin && !isWebmaster) return;
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا التعليق؟'
                : 'Êtes-vous sûr de vouloir supprimer ce commentaire?';
            
            if (confirm(confirmMsg)) {
                if (isPending) {
                    pendingComments = pendingComments.filter(c => c.id !== commentId);
                } else {
                    approvedComments = approvedComments.filter(c => c.id !== commentId);
                }
                
                saveComments();
                renderCommentsList();
                updateCommentsBadge();
            }
        }

        function renderCommentsList() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            
            if (approvedComments.length === 0 && pendingComments.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'no-comments';
                emptyMsg.textContent = currentLanguage === 'ar' 
                    ? 'لا توجد تعليقات بعد. كن أول من يعلق!'
                    : 'Aucun commentaire pour le moment. Soyez le premier à commenter!';
                commentsList.appendChild(emptyMsg);
                return;
            }
            
            // Afficher les commentaires approuvés
            approvedComments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-author">${comment.name}</div>
                        <div class="comment-date">${comment.date}</div>
                    </div>
                    <div class="comment-content">${comment.text}</div>
                    ${(isAdmin || isWebmaster) ? `<div style="margin-top: 10px; text-align: right;">
                        <button class="btn" style="background-color: var(--danger); padding: 5px 10px; font-size: 0.9rem;" onclick="deleteComment(${comment.id}, false)">
                            <i class="fas fa-trash"></i> ${currentLanguage === 'ar' ? 'حذف' : 'Supprimer'}
                        </button>
                    </div>` : ''}
                `;
                commentsList.appendChild(commentItem);
            });
            
            // Si admin ou webmaster, afficher aussi les commentaires en attente
            if ((isAdmin || isWebmaster) && pendingComments.length > 0) {
                const pendingHeader = document.createElement('h3');
                pendingHeader.style.marginTop = '40px';
                pendingHeader.style.color = 'var(--warning)';
                pendingHeader.textContent = currentLanguage === 'ar' 
                    ? 'تعليقات في انتظار الموافقة' 
                    : 'Commentaires en attente d\'approbation';
                commentsList.appendChild(pendingHeader);
                
                pendingComments.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.style.borderLeftColor = 'var(--warning)';
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-author">${comment.name}</div>
                            <div class="comment-date">${comment.date} (en attente)</div>
                        </div>
                        <div class="comment-content">${comment.text}</div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn" style="background-color: var(--success); padding: 5px 10px; font-size: 0.9rem;" onclick="approveComment(${comment.id})">
                                <i class="fas fa-check"></i> ${currentLanguage === 'ar' ? 'قبول' : 'Approuver'}
                            </button>
                            <button class="btn" style="background-color: var(--danger); padding: 5px 10px; font-size: 0.9rem;" onclick="deleteComment(${comment.id}, true)">
                                <i class="fas fa-trash"></i> ${currentLanguage === 'ar' ? 'حذف' : 'Supprimer'}
                            </button>
                        </div>
                    `;
                    commentsList.appendChild(commentItem);
                });
            }
        }

        function updateCommentsBadge() {
            const badge = document.querySelector('.comments-badge');
            if (badge) {
                const totalPending = pendingComments.length;
                badge.textContent = totalPending > 0 ? totalPending : '';
                badge.style.display = totalPending > 0 ? 'flex' : 'none';
            }
        }

        function loadComments() {
            const saved = localStorage.getItem('ansfal_comments');
            if (saved) {
                try {
                    const commentsData = JSON.parse(saved);
                    pendingComments = commentsData.pending || [];
                    approvedComments = commentsData.approved || [];
                } catch (e) {
                    console.error("Erreur lors du chargement des commentaires:", e);
                }
            }
        }

        function saveComments() {
            const commentsData = {
                pending: pendingComments,
                approved: approvedComments
            };
            localStorage.setItem('ansfal_comments', JSON.stringify(commentsData));
        }

        // ==================== BIBLIOTHÈQUE MÉDIA ====================
        function loadMediaLibrary() {
            const saved = localStorage.getItem('ansfal_media');
            if (saved) {
                try {
                    mediaLibrary = JSON.parse(saved);
                } catch (e) {
                    console.error("Erreur lors du chargement de la bibliothèque:", e);
                }
            }
        }

        function saveMediaLibrary() {
            localStorage.setItem('ansfal_media', JSON.stringify(mediaLibrary));
        }

        function addToMediaLibrary(url, title, type) {
            // Vérifier si le média existe déjà
            const exists = mediaLibrary.some(media => media.url === url);
            if (!exists) {
                const mediaItem = {
                    id: Date.now(),
                    title: title || 'Sans titre',
                    url: url,
                    type: type,
                    date: new Date().toLocaleString()
                };
                
                mediaLibrary.push(mediaItem);
                saveMediaLibrary();
                
                // Mettre à jour l'affichage si la bibliothèque est ouverte
                const libraryModal = document.getElementById('mediaLibraryModal');
                if (libraryModal && libraryModal.classList.contains('active')) {
                    updateMediaLibraryContent();
                }
            }
        }

        function showMediaLibrary() {
            const modalId = 'mediaLibraryModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                createMediaLibraryModal();
                modal = document.getElementById(modalId);
            }
            
            // Mettre à jour le contenu de la bibliothèque
            updateMediaLibraryContent();
            
            // Afficher la modale
            modal.classList.add('active');
        }

        function createMediaLibraryModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'mediaLibraryModal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3><i class="fas fa-images"></i> ${currentLanguage === 'ar' ? 'مكتبة الوسائط' : 'Bibliothèque Média'}</h3>
                    
                    <div class="upload-options">
                        <div class="upload-tabs">
                            <button class="upload-tab active" onclick="switchMediaTab('computer')">
                                ${currentLanguage === 'ar' ? 'من جهاز الكمبيوتر' : 'Depuis votre ordinateur'}
                            </button>
                            <button class="upload-tab" onclick="switchMediaTab('url')">
                                ${currentLanguage === 'ar' ? 'من رابط إنترنت' : 'Depuis une URL'}
                            </button>
                        </div>
                        
                        <div class="upload-section active" id="mediaComputerSection">
                            <div class="file-input-container" id="mediaFileDropZone">
                                <label class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                                    <h4>${currentLanguage === 'ar' ? 'اسحب وأفلت ملفات هنا أو انقر للتصفح' : 'Glissez-déposez des fichiers ici ou cliquez pour parcourir'}</h4>
                                    <div style="margin-top: 20px;">
                                        <button type="button" class="btn" onclick="document.getElementById('mediaFileInput').click()" style="background-color: var(--primary);">
                                            <i class="fas fa-folder-open"></i> ${currentLanguage === 'ar' ? 'تصفح الملفات' : 'Parcourir les fichiers'}
                                        </button>
                                    </div>
                                    <input type="file" class="file-input" id="mediaFileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip" style="display: none;">
                                </label>
                                <div class="file-info">
                                    <small>${currentLanguage === 'ar' ? 'الصيغ المدعومة: JPG, PNG, GIF, PDF, DOC, MP4, AVI, MOV, MP3, ZIP' : 'Formats supportés: JPG, PNG, GIF, PDF, DOC, MP4, AVI, MOV, MP3, ZIP'}</small><br>
                                    <small>${currentLanguage === 'ar' ? 'الحد الأقصى للحجم: 50 ميجابايت لكل ملف' : 'Taille max: 50MB par fichier'}</small>
                                </div>
                            </div>
                            
                            <div class="upload-progress" id="mediaUploadProgress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="mediaProgressFill"></div>
                                </div>
                                <div class="progress-text" id="mediaProgressText">0%</div>
                            </div>
                        </div>
                        
                        <div class="upload-section" id="mediaURLSection">
                            <div style="margin-bottom: 15px;">
                                <input type="text" id="mediaUrlInput" placeholder="${currentLanguage === 'ar' ? 'https://example.com/image.jpg' : 'https://exemple.com/image.jpg'}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="text-align: center;">
                                <button class="btn" onclick="addUrlToLibrary()" style="background-color: var(--success);">
                                    <i class="fas fa-plus"></i> ${currentLanguage === 'ar' ? 'إضافة الرابط إلى المكتبة' : 'Ajouter le lien à la bibliothèque'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="libraryContent" style="margin-top: 30px;">
                        <h4>${currentLanguage === 'ar' ? 'الوسائط المحفوظة' : 'Médias Sauvegardés'}</h4>
                        <div class="gallery-grid" id="libraryGrid">
                            <!-- Les médias seront affichés ici -->
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="closeModal('mediaLibraryModal')" style="background-color: var(--dark);">
                            <i class="fas fa-times"></i> ${currentLanguage === 'ar' ? 'إغلاق' : 'Fermer'}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialiser les événements
            setTimeout(() => {
                const fileInput = document.getElementById('mediaFileInput');
                const dropZone = document.getElementById('mediaFileDropZone');
                
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleMediaFileUpload(e);
                    });
                }
                
                if (dropZone) {
                    dropZone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.add('dragover');
                    });
                    
                    dropZone.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('dragover');
                    });
                    
                    dropZone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            // Créer un nouvel événement change
                            const dataTransfer = new DataTransfer();
                            for (let i = 0; i < files.length; i++) {
                                if (files[i].size <= 50 * 1024 * 1024) {
                                    dataTransfer.items.add(files[i]);
                                }
                            }
                            
                            fileInput.files = dataTransfer.files;
                            const event = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(event);
                        }
                    });
                }
                
                // Cacher la barre de progression initialement
                const progress = document.getElementById('mediaUploadProgress');
                if (progress) {
                    progress.style.display = 'none';
                }
            }, 100);
        }

        function switchMediaTab(tabName) {
            document.querySelectorAll('.upload-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.upload-section').forEach(section => section.classList.remove('active'));
            
            const tabButton = document.querySelector(`.upload-tab[onclick*="${tabName}"]`);
            if (tabButton) tabButton.classList.add('active');
            
            const sectionElement = document.getElementById(`media${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Section`);
            if (sectionElement) sectionElement.classList.add('active');
        }

        function handleMediaFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // Afficher la progression
            const progress = document.getElementById('mediaUploadProgress');
            const progressFill = document.getElementById('mediaProgressFill');
            const progressText = document.getElementById('mediaProgressText');
            
            progress.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            
            let completed = 0;
            const total = files.length;
            
            // Traiter chaque fichier
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Vérifier la taille (max 50MB)
                if (file.size > 50 * 1024 * 1024) {
                    showNotification(
                        currentLanguage === 'ar' 
                            ? `الملف كبير جدًا: ${file.name} (${(file.size / (1024*1024)).toFixed(2)}MB)`
                            : `Fichier trop grand: ${file.name} (${(file.size / (1024*1024)).toFixed(2)}MB)`,
                        'error'
                    );
                    completed++;
                    updateProgress(completed, total, progressFill, progressText);
                    continue;
                }
                
                // Lire le fichier
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileUrl = e.target.result;
                    const fileName = file.name;
                    const fileType = getFileType(file);
                    
                    const mediaItem = {
                        id: Date.now() + i,
                        title: fileName,
                        url: fileUrl,
                        type: fileType,
                        date: new Date().toLocaleString(),
                        size: formatFileSize(file.size)
                    };
                    
                    mediaLibrary.push(mediaItem);
                    saveMediaLibrary();
                    
                    completed++;
                    updateProgress(completed, total, progressFill, progressText);
                    
                    // Si tous les fichiers sont traités, mettre à jour l'affichage
                    if (completed === total) {
                        setTimeout(() => {
                            updateMediaLibraryContent();
                            // Masquer la progression après 1 seconde
                            setTimeout(() => {
                                progress.style.display = 'none';
                            }, 1000);
                        }, 500);
                    }
                };
                
                reader.onerror = function() {
                    showNotification(
                        currentLanguage === 'ar' 
                            ? `خطأ في قراءة الملف: ${file.name}`
                            : `Erreur de lecture du fichier: ${file.name}`,
                        'error'
                    );
                    completed++;
                    updateProgress(completed, total, progressFill, progressText);
                };
                
                reader.readAsDataURL(file);
            }
            
            // Réinitialiser l'input
            event.target.value = '';
        }

        function updateProgress(completed, total, progressFill, progressText) {
            const percent = Math.round((completed / total) * 100);
            progressFill.style.width = percent + '%';
            progressText.textContent = percent + '%';
        }

        function getFileType(file) {
            if (file.type.startsWith('image/')) return 'image';
            if (file.type.startsWith('video/')) return 'video';
            if (file.type.startsWith('audio/')) return 'audio';
            if (file.type.includes('pdf')) return 'pdf';
            if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) return 'document';
            if (file.name.endsWith('.zip')) return 'archive';
            if (file.name.endsWith('.txt')) return 'text';
            return 'file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function addUrlToLibrary() {
            const urlInput = document.getElementById('mediaUrlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert(currentLanguage === 'ar' ? 'يرجى إدخال رابط' : 'Veuillez entrer une URL');
                return;
            }
            
            const title = url.split('/').pop() || 'Lien externe';
            const type = getFileTypeFromUrl(url);
            
            const mediaItem = {
                id: Date.now(),
                title: title,
                url: url,
                type: type,
                date: new Date().toLocaleString()
            };
            
            mediaLibrary.push(mediaItem);
            saveMediaLibrary();
            updateMediaLibraryContent();
            
            // Réinitialiser le champ
            urlInput.value = '';
            
            showNotification(currentLanguage === 'ar' 
                ? 'تمت الإضافة إلى المكتبة!' 
                : 'Ajouté à la bibliothèque!', 'success');
        }

        function updateMediaLibraryContent() {
            const libraryGrid = document.getElementById('libraryGrid');
            if (!libraryGrid) return;
            
            libraryGrid.innerHTML = '';
            
            if (mediaLibrary.length === 0) {
                libraryGrid.innerHTML = `<div class="empty-state">
                    <i class="fas fa-images"></i>
                    <p>${currentLanguage === 'ar' ? 'لا توجد وسائط في المكتبة' : 'Aucun média dans la bibliothèque'}</p>
                    <small>${currentLanguage === 'ar' ? 'قم برفع بعض الوسائط لبدء الاستخدام' : 'Téléchargez des médias pour commencer'}</small>
                </div>`;
                return;
            }
            
            // Trier par date (du plus récent au plus ancien)
            const sortedMedia = [...mediaLibrary].sort((a, b) => b.id - a.id);
            
            sortedMedia.forEach(media => {
                const mediaElement = document.createElement('div');
                mediaElement.className = 'gallery-item';
                mediaElement.style.position = 'relative';
                mediaElement.style.cursor = 'pointer';
                mediaElement.onclick = function() {
                    selectMediaFromLibrary(media);
                };
                
                let icon = 'fas fa-file';
                let bgColor = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                let displayContent = '';
                
                switch(media.type) {
                    case 'image':
                        icon = 'fas fa-image';
                        bgColor = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
                        displayContent = `
                            <img src="${media.url}" alt="${media.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px 5px 0 0;">
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    case 'video':
                        icon = 'fas fa-video';
                        bgColor = 'linear-gradient(135deg, #FF9800, #FF5722)';
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    case 'pdf':
                        icon = 'fas fa-file-pdf';
                        bgColor = 'linear-gradient(135deg, #F44336, #E91E63)';
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                                <div style="margin-top: 10px; font-size: 0.8rem;">PDF</div>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    case 'document':
                        icon = 'fas fa-file-word';
                        bgColor = 'linear-gradient(135deg, #2196F3, #03A9F4)';
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                                <div style="margin-top: 10px; font-size: 0.8rem;">DOC</div>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    case 'archive':
                        icon = 'fas fa-file-archive';
                        bgColor = 'linear-gradient(135deg, #795548, #8D6E63)';
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                                <div style="margin-top: 10px; font-size: 0.8rem;">ZIP</div>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    case 'text':
                        icon = 'fas fa-file-alt';
                        bgColor = 'linear-gradient(135deg, #9C27B0, #673AB7)';
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                                <div style="margin-top: 10px; font-size: 0.8rem;">TXT</div>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                        break;
                    default:
                        displayContent = `
                            <div style="background: ${bgColor}; color: white; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px 5px 0 0;">
                                <i class="${icon}" style="font-size: 3rem;"></i>
                                <div style="margin-top: 10px; font-size: 0.8rem;">${media.type.toUpperCase()}</div>
                            </div>
                            <div style="padding: 10px; font-size: 0.9rem; background: white; border-radius: 0 0 5px 5px;">${media.title}</div>
                        `;
                }
                
                mediaElement.innerHTML = displayContent;
                
                // Bouton de suppression
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'remove-item-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = currentLanguage === 'ar' ? 'حذف من المكتبة' : 'Supprimer de la bibliothèque';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.style.backgroundColor = 'var(--danger)';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeFromLibrary(media.id);
                };
                
                mediaElement.appendChild(deleteBtn);
                libraryGrid.appendChild(mediaElement);
            });
        }

        function selectMediaFromLibrary(media) {
            // Fermer la modale
            closeModal('mediaLibraryModal');
            
            // Afficher une notification
            showNotification(currentLanguage === 'ar' 
                ? `تم اختيار "${media.title}"` 
                : `"${media.title}" sélectionné`, 'info');
            
            // Retourner l'URL pour utilisation
            return media.url;
        }

        function removeFromLibrary(id) {
            if (!isAdmin && !isWebmaster) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين والويبماستر' : 'Accès réservé aux administrateurs et webmasters');
                return;
            }
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا العنصر من المكتبة؟'
                : 'Êtes-vous sûr de vouloir supprimer cet élément de la bibliothèque?';
            
            if (confirm(confirmMsg)) {
                mediaLibrary = mediaLibrary.filter(media => media.id !== id);
                saveMediaLibrary();
                updateMediaLibraryContent();
                
                showNotification(currentLanguage === 'ar' 
                    ? 'تم الحذف بنجاح' 
                    : 'Supprimé avec succès', 'success');
            }
        }

        // ==================== MODALES DE CONNEXION ====================
        function showLoginModal() {
            const modalId = 'loginModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                createLoginModal();
                modal = document.getElementById(modalId);
            }
            
            modal.classList.add('active');
        }

        function showWebmasterLoginModal() {
            const modalId = 'webmasterLoginModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                createWebmasterLoginModal();
                modal = document.getElementById(modalId);
            }
            
            modal.classList.add('active');
        }

        function createLoginModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'loginModal';
            
            modal.innerHTML = `
                <div class="login-form">
                    <h3><i class="fas fa-lock"></i> ${currentLanguage === 'ar' ? 'تسجيل دخول المدير' : 'Connexion Administrateur'}</h3>
                    
                    <div class="password-input">
                        <input type="password" id="adminPassword" placeholder="${currentLanguage === 'ar' ? 'كلمة مرور المدير' : 'Mot de passe administrateur'}">
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('adminPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableEditMode" checked>
                            <span>${currentLanguage === 'ar' ? 'تفعيل وضع التعديل عند الدخول' : 'Activer le mode édition après connexion'}</span>
                        </label>
                    </div>
                    
                    <button class="btn" onclick="loginAdmin()" style="width: 100%; margin-bottom: 15px;">
                        <i class="fas fa-sign-in-alt"></i> ${currentLanguage === 'ar' ? 'تسجيل الدخول' : 'Se connecter'}
                    </button>
                    
                    <button class="btn" onclick="closeModal('loginModal')" style="width: 100%; background-color: var(--dark);">
                        ${currentLanguage === 'ar' ? 'إلغاء' : 'Annuler'}
                    </button>
                    
                    <p style="margin-top: 20px; font-size: 0.9rem; color: #666; text-align: center;">
                        ${currentLanguage === 'ar' ? 'كلمة المرور الافتراضية:' : 'Mot de passe par défaut:'} 
                        <code>admin123</code>
                    </p>
                    <p style="font-size: 0.8rem; color: var(--warning); text-align: center;">
                        ${currentLanguage === 'ar' ? 'قم بتغييره بعد أول تسجيل دخول!' : 'Changez-le après la première connexion!'}
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function createWebmasterLoginModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'webmasterLoginModal';
            
            modal.innerHTML = `
                <div class="login-form">
                    <h3><i class="fas fa-lock"></i> ${currentLanguage === 'ar' ? 'تسجيل دخول ويبماستر' : 'Connexion Webmaster'}</h3>
                    
                    <div class="password-input">
                        <input type="password" id="webmasterPassword" placeholder="${currentLanguage === 'ar' ? 'كلمة مرور ويبماستر' : 'Mot de passe webmaster'}">
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('webmasterPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableWebmasterEditMode" checked>
                            <span>${currentLanguage === 'ar' ? 'تفعيل وضع التعديل عند الدخول' : 'Activer le mode édition après connexion'}</span>
                        </label>
                    </div>
                    
                    <button class="btn" onclick="loginWebmaster()" style="width: 100%; margin-bottom: 15px;">
                        <i class="fas fa-sign-in-alt"></i> ${currentLanguage === 'ar' ? 'تسجيل الدخول' : 'Se connecter'}
                    </button>
                    
                    <button class="btn" onclick="closeModal('webmasterLoginModal')" style="width: 100%; background-color: var(--dark);">
                        ${currentLanguage === 'ar' ? 'إلغاء' : 'Annuler'}
                    </button>
                    
                    <p style="margin-top: 20px; font-size: 0.9rem; color: #666; text-align: center;">
                        ${currentLanguage === 'ar' ? 'كلمة المرور الافتراضية:' : 'Mot de passe par défaut:'} 
                        <code>web123</code>
                    </p>
                    <p style="font-size: 0.8rem; color: var(--warning); text-align: center;">
                        ${currentLanguage === 'ar' ? 'قم بتغييره بعد أول تسجيل دخول!' : 'Changez-le après la première connexion!'}
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function loginAdmin() {
            const passwordInput = document.getElementById('adminPassword');
            const enableEditMode = document.getElementById('enableEditMode');
            const password = passwordInput.value;
            
            // Vérifier le mot de passe
            const user = users.find(u => u.username === 'admin' && u.password === password);
            
            if (user) {
                isAdmin = true;
                localStorage.setItem('ansfal_admin_logged_in', 'true');
                localStorage.setItem('ansfal_admin_session', Date.now().toString());
                
                // Activer la barre admin si la case est cochée
                if (enableEditMode && enableEditMode.checked) {
                    activateAdminBar();
                }
                
                // Fermer la modale
                closeModal('loginModal');
                
                // Afficher un message de bienvenue
                showNotification(currentLanguage === 'ar' 
                    ? 'مرحباً بك في لوحة التحكم!' 
                    : 'Bienvenue dans le panneau d\'administration!', 'success');
                
                // Mettre à jour l'affichage
                updateVisitorDisplay();
            } else {
                alert(currentLanguage === 'ar' 
                    ? 'كلمة المرور غير صحيحة!'
                    : 'Mot de passe incorrect!');
                passwordInput.focus();
            }
        }

        function loginWebmaster() {
            const passwordInput = document.getElementById('webmasterPassword');
            const enableEditMode = document.getElementById('enableWebmasterEditMode');
            const password = passwordInput.value;
            
            // Vérifier le mot de passe
            const user = users.find(u => u.username === 'webmaster' && u.password === password);
            
            if (user) {
                isWebmaster = true;
                localStorage.setItem('ansfal_webmaster_logged_in', 'true');
                localStorage.setItem('ansfal_webmaster_session', Date.now().toString());
                
                // Activer la barre webmaster si la case est cochée
                if (enableEditMode && enableEditMode.checked) {
                    activateWebmasterBar();
                }
                
                // Fermer la modale
                closeModal('webmasterLoginModal');
                
                // Afficher un message de bienvenue
                showNotification(currentLanguage === 'ar' 
                    ? 'مرحباً بك في لوحة التحكم!' 
                    : 'Bienvenue dans le panneau webmaster!', 'success');
                
                // Mettre à jour l'affichage
                updateVisitorDisplay();
            } else {
                alert(currentLanguage === 'ar' 
                    ? 'كلمة المرور غير صحيحة!'
                    : 'Mot de passe incorrect!');
                passwordInput.focus();
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            localStorage.removeItem('ansfal_admin_logged_in');
            localStorage.removeItem('ansfal_admin_session');
            
            // Désactiver la barre admin
            document.getElementById('adminBar').classList.remove('active');
            document.getElementById('mediaLibraryBtn').classList.remove('active');
            
            // Masquer les boutons d'édition
            hideEditButtons();
            
            showNotification(currentLanguage === 'ar' 
                ? 'تم تسجيل الخروج بنجاح' 
                : 'Déconnexion réussie', 'info');
        }

        function logoutWebmaster() {
            isWebmaster = false;
            localStorage.removeItem('ansfal_webmaster_logged_in');
            localStorage.removeItem('ansfal_webmaster_session');
            
            // Désactiver la barre webmaster
            document.getElementById('webmasterBar').classList.remove('active');
            document.getElementById('mediaLibraryBtn').classList.remove('active');
            
            // Masquer les boutons d'upload
            hideUploadButtons();
            
            showNotification(currentLanguage === 'ar' 
                ? 'تم تسجيل الخروج بنجاح' 
                : 'Déconnexion réussie', 'info');
        }

        function checkAdminStatus() {
            const loggedIn = localStorage.getItem('ansfal_admin_logged_in');
            const sessionTime = localStorage.getItem('ansfal_admin_session');
            
            if (loggedIn === 'true' && sessionTime) {
                // Vérifier si la session est expirée (12 heures)
                const sessionAge = Date.now() - parseInt(sessionTime);
                const twelveHours = 12 * 60 * 60 * 1000;
                
                if (sessionAge < twelveHours) {
                    isAdmin = true;
                    showEditButtons();
                } else {
                    // Session expirée
                    localStorage.removeItem('ansfal_admin_logged_in');
                    localStorage.removeItem('ansfal_admin_session');
                }
            }
        }

        function checkWebmasterStatus() {
            const loggedIn = localStorage.getItem('ansfal_webmaster_logged_in');
            const sessionTime = localStorage.getItem('ansfal_webmaster_session');
            
            if (loggedIn === 'true' && sessionTime) {
                // Vérifier si la session est expirée (12 heures)
                const sessionAge = Date.now() - parseInt(sessionTime);
                const twelveHours = 12 * 60 * 60 * 1000;
                
                if (sessionAge < twelveHours) {
                    isWebmaster = true;
                    showUploadButtons();
                } else {
                    // Session expirée
                    localStorage.removeItem('ansfal_webmaster_logged_in');
                    localStorage.removeItem('ansfal_webmaster_session');
                }
            }
        }

        function showChangePasswordModal(role) {
            const oldPassMsg = currentLanguage === 'ar' 
                ? 'أدخل كلمة المرور الحالية:' 
                : 'Entrez le mot de passe actuel:';
            const oldPass = prompt(oldPassMsg);
            
            if (!oldPass) return;
            
            // Vérifier le mot de passe selon le rôle
            let user;
            if (role === 'admin') {
                user = users.find(u => u.username === 'admin');
            } else {
                user = users.find(u => u.username === 'webmaster');
            }
            
            if (!user || user.password !== oldPass) {
                alert(currentLanguage === 'ar' 
                    ? 'كلمة المرور الحالية غير صحيحة!'
                    : 'Mot de passe actuel incorrect!');
                return;
            }
            
            const newPassMsg = currentLanguage === 'ar' 
                ? 'أدخل كلمة المرور الجديدة:' 
                : 'Entrez le nouveau mot de passe:';
            const newPass = prompt(newPassMsg);
            
            if (!newPass) return;
            
            const confirmPassMsg = currentLanguage === 'ar' 
                ? 'تأكيد كلمة المرور الجديدة:' 
                : 'Confirmez le nouveau mot de passe:';
            const confirmPass = prompt(confirmPassMsg);
            
            if (newPass !== confirmPass) {
                alert(currentLanguage === 'ar' 
                    ? 'كلمات المرور غير متطابقة!'
                    : 'Les mots de passe ne correspondent pas!');
                return;
            }
            
            // Mettre à jour le mot de passe
            user.password = newPass;
            saveUsers();
            
            alert(currentLanguage === 'ar' 
                ? 'تم تغيير كلمة المرور بنجاح!' 
                : 'Mot de passe changé avec succès!');
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                button.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showCommentsModal() {
            // Faire défiler jusqu'à la section commentaires
            document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });
        }

        function showCommentsAdmin() {
            // Faire défiler jusqu'à la section commentaires
            document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });
        }

        function scrollToComments() {
            document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== GESTION DES UTILISATEURS ====================
        function loadUsers() {
            const saved = localStorage.getItem('ansfal_users');
            if (saved) {
                try {
                    users = JSON.parse(saved);
                } catch (e) {
                    console.error("Erreur lors du chargement des utilisateurs:", e);
                }
            }
        }

        function saveUsers() {
            localStorage.setItem('ansfal_users', JSON.stringify(users));
        }

        function showUserManagement() {
            if (!isAdmin) {
                alert(currentLanguage === 'ar' ? 'الدخول مقصور على المديرين' : 'Accès réservé aux administrateurs');
                return;
            }
            
            const modalId = 'userManagementModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                createUserManagementModal();
                modal = document.getElementById(modalId);
            }
            
            updateUsersList();
            modal.classList.add('active');
        }

        function createUserManagementModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'userManagementModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3><i class="fas fa-users"></i> ${currentLanguage === 'ar' ? 'إدارة المستخدمين' : 'Gestion des Utilisateurs'}</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="showAddUserModal()" style="background-color: var(--success);">
                            <i class="fas fa-user-plus"></i> ${currentLanguage === 'ar' ? 'إضافة مستخدم جديد' : 'Ajouter un nouvel utilisateur'}
                        </button>
                    </div>
                    
                    <div class="user-list" id="usersList">
                        <!-- La liste des utilisateurs sera affichée ici -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="closeModal('userManagementModal')" style="background-color: var(--dark);">
                            <i class="fas fa-times"></i> ${currentLanguage === 'ar' ? 'إغلاق' : 'Fermer'}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info">
                        <div>
                            <strong>${user.name}</strong><br>
                            <small>${user.username}</small>
                        </div>
                        <span class="user-role ${user.role}">${user.role === 'admin' ? (currentLanguage === 'ar' ? 'مدير' : 'Admin') : (currentLanguage === 'ar' ? 'ويبماستر' : 'Webmaster')}</span>
                    </div>
                    <div>
                        ${user.username !== 'admin' && user.username !== 'webmaster' ? `
                        <button class="btn" onclick="deleteUser(${user.id})" style="background-color: var(--danger); padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> ${currentLanguage === 'ar' ? 'حذف' : 'Supprimer'}
                        </button>
                        ` : ''}
                    </div>
                `;
                usersList.appendChild(userItem);
            });
        }

        function showAddUserModal() {
            const modalId = 'addUserModal';
            let modal = document.getElementById(modalId);
            
            if (modal) {
                modal.parentNode.removeChild(modal);
            }
            
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = modalId;
            
            modal.innerHTML = `
                <div class="login-form" style="max-width: 500px;">
                    <h3><i class="fas fa-user-plus"></i> ${currentLanguage === 'ar' ? 'إضافة مستخدم جديد' : 'Ajouter un nouvel utilisateur'}</h3>
                    
                    <input type="text" id="newUserName" placeholder="${currentLanguage === 'ar' ? 'اسم المستخدم' : 'Nom d\'utilisateur'}">
                    <input type="text" id="newUserFullName" placeholder="${currentLanguage === 'ar' ? 'الاسم الكامل' : 'Nom complet'}">
                    <input type="password" id="newUserPassword" placeholder="${currentLanguage === 'ar' ? 'كلمة المرور' : 'Mot de passe'}">
                    
                    <select id="newUserRole" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="webmaster">${currentLanguage === 'ar' ? 'ويبماستر' : 'Webmaster'}</option>
                        <option value="admin">${currentLanguage === 'ar' ? 'مدير' : 'Administrateur'}</option>
                    </select>
                    
                    <button class="btn" onclick="addNewUser()" style="width: 100%; margin-bottom: 15px;">
                        <i class="fas fa-save"></i> ${currentLanguage === 'ar' ? 'حفظ المستخدم' : 'Sauvegarder l\'utilisateur'}
                    </button>
                    
                    <button class="btn" onclick="closeModal('${modalId}')" style="width: 100%; background-color: var(--dark);">
                        ${currentLanguage === 'ar' ? 'إلغاء' : 'Annuler'}
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
        }

        function addNewUser() {
            const username = document.getElementById('newUserName').value.trim();
            const fullName = document.getElementById('newUserFullName').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !fullName || !password) {
                alert(currentLanguage === 'ar' 
                    ? 'يرجى ملء جميع الحقول' 
                    : 'Veuillez remplir tous les champs');
                return;
            }
            
            // Vérifier si l'utilisateur existe déjà
            if (users.find(u => u.username === username)) {
                alert(currentLanguage === 'ar' 
                    ? 'اسم المستخدم موجود بالفعل' 
                    : 'Ce nom d\'utilisateur existe déjà');
                return;
            }
            
            // Ajouter le nouvel utilisateur
            const newUser = {
                id: Date.now(),
                username: username,
                name: fullName,
                password: password,
                role: role
            };
            
            users.push(newUser);
            saveUsers();
            updateUsersList();
            
            // Fermer la modale
            closeModal('addUserModal');
            
            alert(currentLanguage === 'ar' 
                ? 'تمت إضافة المستخدم بنجاح!' 
                : 'Utilisateur ajouté avec succès!');
        }

        function deleteUser(userId) {
            if (!isAdmin) return;
            
            const confirmMsg = currentLanguage === 'ar' 
                ? 'هل أنت متأكد أنك تريد حذف هذا المستخدم؟' 
                : 'Êtes-vous sûr de vouloir supprimer cet utilisateur?';
            
            if (confirm(confirmMsg)) {
                users = users.filter(u => u.id !== userId);
                saveUsers();
                updateUsersList();
                
                alert(currentLanguage === 'ar' 
                    ? 'تم حذف المستخدم بنجاح' 
                    : 'Utilisateur supprimé avec succès');
            }
        }

        // ==================== GESTION DES VISITEURS ====================
        function loadVisitorStats() {
            const saved = localStorage.getItem('ansfal_visitor_stats');
            if (saved) {
                try {
                    const stats = JSON.parse(saved);
                    visitorStats.total = stats.total || 0;
                    visitorStats.online = stats.online || 0;
                    visitorStats.lastVisit = stats.lastVisit || null;
                } catch (e) {
                    console.error("Erreur lors du chargement des statistiques:", e);
                }
            }
            
            // Mettre à jour les compteurs
            updateVisitorCount();
        }

        function updateVisitorCount() {
            // Augmenter le compteur total
            visitorStats.total = (visitorStats.total || 0) + 1;
            
            // Mettre à jour les visiteurs en ligne
            const onlineKey = 'ansfal_online_visitors';
            let onlineVisitors = JSON.parse(localStorage.getItem(onlineKey) || '[]');
            
            // Nettoyer les entrées expirées (plus de 5 minutes)
            const now = Date.now();
            onlineVisitors = onlineVisitors.filter(visitor => now - visitor.time < 5 * 60 * 1000);
            
            // Ajouter ou mettre à jour le visiteur actuel
            const visitorId = localStorage.getItem('ansfal_visitor_id') || generateVisitorId();
            localStorage.setItem('ansfal_visitor_id', visitorId);
            
            const existingIndex = onlineVisitors.findIndex(v => v.id === visitorId);
            if (existingIndex !== -1) {
                onlineVisitors[existingIndex].time = now;
            } else {
                onlineVisitors.push({ id: visitorId, time: now });
            }
            
            // Sauvegarder
            localStorage.setItem(onlineKey, JSON.stringify(onlineVisitors));
            visitorStats.online = onlineVisitors.length;
            
            // Mettre à jour la dernière visite
            visitorStats.lastVisit = new Date().toLocaleString('fr-FR');
            
            // Sauvegarder les statistiques
            saveVisitorStats();
            
            // Mettre à jour l'affichage
            updateVisitorDisplay();
        }

        function generateVisitorId() {
            return 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveVisitorStats() {
            localStorage.setItem('ansfal_visitor_stats', JSON.stringify(visitorStats));
        }

        function updateVisitorDisplay() {
            const totalElement = document.getElementById('totalVisitors');
            const onlineElement = document.getElementById('onlineVisitors');
            const lastVisitElement = document.getElementById('lastVisit');
            
            if (totalElement) {
                totalElement.textContent = visitorStats.total.toLocaleString();
            }
            if (onlineElement) {
                onlineElement.textContent = visitorStats.online.toLocaleString();
            }
            if (lastVisitElement) {
                lastVisitElement.textContent = visitorStats.lastVisit || '--/--/---- --:--:--';
            }
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, type = 'info') {
            // Créer la notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: ${currentLanguage === 'ar' ? 'auto' : '20px'};
                left: ${currentLanguage === 'ar' ? '20px' : 'auto'};
                background-color: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: var(--shadow);
                z-index: 3000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ==================== ÉVÉNEMENTS ====================
        function initEventListeners() {
            // Fermer les modales en cliquant en dehors
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal.active');
                modals.forEach(modal => {
                    if (!modal.contains(event.target) && !event.target.closest('.comments-btn, .login-btn, .webmaster-btn-float, .media-library-btn')) {
                        modal.classList.remove('active');
                    }
                });
                
                // Fermer les barres admin/webmaster en cliquant en dehors
                const adminBar = document.getElementById('adminBar');
                if (adminBar && adminBar.classList.contains('active') && 
                    !adminBar.contains(event.target) && 
                    event.target.id !== 'loginBtn' &&
                    !event.target.closest('#loginBtn')) {
                    adminBar.classList.remove('active');
                    document.getElementById('mediaLibraryBtn').classList.remove('active');
                }
                
                const webmasterBar = document.getElementById('webmasterBar');
                if (webmasterBar && webmasterBar.classList.contains('active') && 
                    !webmasterBar.contains(event.target) && 
                    event.target.id !== 'webmasterBtn' &&
                    !event.target.closest('#webmasterBtn')) {
                    webmasterBar.classList.remove('active');
                    document.getElementById('mediaLibraryBtn').classList.remove('active');
                }
            });
            
            // Prévenir la fermeture des barres quand on clique sur leurs boutons
            const adminBar = document.getElementById('adminBar');
            if (adminBar) {
                adminBar.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            }
            
            const webmasterBar = document.getElementById('webmasterBar');
            if (webmasterBar) {
                webmasterBar.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            }
            
            // Navigation fluide
            document.querySelectorAll('nav a').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href.startsWith('#')) {
                        e.preventDefault();
                        const targetId = href.substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                });
            });
            
            // Initialiser WhatsApp
            const whatsappBtn = document.getElementById('whatsappBtn');
            if (whatsappBtn) {
                const phoneNumber = '+212612345678'; // Remplacer par le vrai numéro
                whatsappBtn.href = `https://wa.me/${phoneNumber.replace(/\D/g, '')}`;
                whatsappBtn.target = '_blank';
            }
            
            // Mettre à jour les visiteurs en ligne périodiquement
            setInterval(updateVisitorCount, 60000); // Toutes les minutes
        }

        // ==================== FONCTIONS UTILITAIRES ====================
        function showUploadModal() {
            showMediaLibrary();
        }

        // ==================== DÉMARAGE ====================
        // Initialiser les visiteurs
        setTimeout(updateVisitorCount, 1000);
        
        // Mettre à jour la langue au chargement
        window.addEventListener('load', function() {
            console.log("Site ANSFAL prêt!");
            // Forcer le rafraîchissement des traductions
            translateCompletePage(currentLanguage);
        });

    </script>
</body>
</html>
